<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.0">Jekyll</generator><link href="https://www.rtancman.com.br/feed.xml" rel="self" type="application/atom+xml" /><link href="https://www.rtancman.com.br/" rel="alternate" type="text/html" /><updated>2022-10-21T14:22:51+00:00</updated><id>https://www.rtancman.com.br/feed.xml</id><title type="html">Raffael Tancman</title><subtitle>Carioca, Bodyboarder, gamer #apaixonadoPorLOL e desenvolvedor poliglota. Trabalho com web desde 2008 e atualmente estou no Jusbrasil.</subtitle><author><name>Raffael Tancman</name></author><entry><title type="html">Elasticsearch Debug Remoto</title><link href="https://www.rtancman.com.br/elasticsearch/elasticsearch-debug-remoto.html" rel="alternate" type="text/html" title="Elasticsearch Debug Remoto" /><published>2022-10-19T09:00:00+00:00</published><updated>2022-10-19T09:00:00+00:00</updated><id>https://www.rtancman.com.br/elasticsearch/elasticsearch-debug-remoto</id><content type="html" xml:base="https://www.rtancman.com.br/elasticsearch/elasticsearch-debug-remoto.html"><![CDATA[<p>Quem nunca precisou realizar um debug? Essa ferramenta é muito importante para ajudar a entender sistemas e comportamentos inesperados, vulgo bugs!</p>

<p>Trazendo para o mundo da JVM e Elastic, a um tempinho acabei contribuindo para um plugin do elasticsearch, o <a href="https://github.com/o19s/elasticsearch-learning-to-rank">elasticsearch-learning-to-rank</a>, precisei debugar remotamente para entender como as coisas estavam funcionando e acabei encontrando um bug e solucionando em seguida. Neste momento não cheguei a documentar o processo. Recentemente um amigo de trabalho perguntou em como poderia investigar um possível problema de concorrência nos analyzers do elasticsearch e acabei sugerindo o remote debug.</p>

<p>Após esse papo resolvi escrever esse post em PT-BR para documentar esse processo.</p>

<h2 id="configurando-o-ambiente-de-trabalho">Configurando o ambiente de trabalho</h2>
<p>Meus amores pelo <a href="https://sdkman.io/">sdkman</a> já foram expressados em outros posts do meu blog e por isso no universo JVM recomendo para gerenciar as diversas versões de java, scala, sbt e por aê vai. Neste caso vamos usar o JDK 17.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># instalando o sdkman</span>
curl <span class="nt">-s</span> <span class="s2">"https://get.sdkman.io"</span> | bash


<span class="c"># instalando versões da jdk que precisamos para compilar o elastic</span>
sdk <span class="nb">install </span>17.0.2-open
sdk use java 17.0.2-open
</code></pre></div></div>

<h2 id="baixando--compilando-o-projeto">Baixando &amp; Compilando o projeto</h2>

<p>Vamos utilizar como base a versão 8.4.3 e o git para clonar o projeto e ir para a branch dessa versão.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>elasticsearch-debug 
<span class="nb">cd </span>elasticsearch-debug
git clone git@github.com:elastic/elasticsearch.git
<span class="nb">cd </span>elasticsearch
git checkout 8.4
</code></pre></div></div>

<p>Compilando…</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./gradlew localDistro
</code></pre></div></div>

<p>Se tudo deu certo você deverá ver essa mensagem:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> Task :localDistro
Elasticsearch distribution installed to ~/elasticsearch-debug/elasticsearch/build/distribution/local/elasticsearch-8.4.3-SNAPSHOT

BUILD SUCCESSFUL <span class="k">in </span>9m
456 actionable tasks: 456 executed
</code></pre></div></div>

<h2 id="debugando">Debugando!</h2>

<p>Tenho 2 formas para debugar o elastic que são:</p>
<ul>
  <li><a href="#debug-via-gradlew">Debug via gradlew</a></li>
  <li><a href="#debug-via-docker--java_options">Debug via Docker + JAVA_OPTIONS</a></li>
</ul>

<p>Eu particularmente gosto de utilizar uma IDE para interagir com o a aplicação em modo debug. Nesse post eu vou demonstrar como podemos fazer nas IDEs abaixo:</p>
<ul>
  <li><a href="#debug-no-intellij-idea">IntelliJ IDEA</a></li>
  <li><a href="#debug-no-vscode">VSCode</a></li>
</ul>

<h3 id="debug-via-gradlew">Debug via gradlew</h3>

<p>Quando não preciso instalar um plugin de terceiros no elastic gosto de executar na forma mais convencional que é rodando a aplicação em modo debug na JVM.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./gradlew run <span class="nt">--debug-jvm</span>
</code></pre></div></div>

<p>Após rodar este comando o projeto do elastic vai ficar executando localmente com a opção de debug habilitada. Basta agora dar um <code class="language-plaintext highlighter-rouge">Attach to Process</code> em sua IDE de preferência. Nesse post vou demonstrar como rodar com o <a href="#debug-no-intellij-idea">IntelliJ</a> e no VSCode.</p>

<h3 id="debug-via-docker--java_options">Debug via Docker + JAVA_OPTIONS</h3>

<p>Aqui vamos subir o elastic utilizando o docker mas passando umas variaveis para habilitar o modo debug. Por praticidade eu acabei criando um docker-compose.yml com o seguinte conteúdo:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2.2'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">es</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/elasticsearch/elasticsearch:8.4.3</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">es-remote-debug-8-4-3</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">node.name=es-remote-debug-8-4-3</span>
      <span class="pi">-</span> <span class="s">cluster.name=es-docker-cluster</span>
      <span class="pi">-</span> <span class="s">discovery.seed_hosts=es-remote-debug-8-4-3</span>
      <span class="pi">-</span> <span class="s">xpack.security.enabled=false</span>
      <span class="pi">-</span> <span class="s">cluster.initial_master_nodes=es-remote-debug-8-4-3</span>
      <span class="pi">-</span> <span class="s">bootstrap.memory_lock=true</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">ES_JAVA_OPTS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5007</span><span class="nv"> </span><span class="s">-Xms512m</span><span class="nv"> </span><span class="s">-Xmx512m"</span>
    <span class="na">ulimits</span><span class="pi">:</span>
      <span class="na">memlock</span><span class="pi">:</span>
        <span class="na">soft</span><span class="pi">:</span> <span class="s">-1</span>
        <span class="na">hard</span><span class="pi">:</span> <span class="s">-1</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">es_data:/usr/share/elasticsearch/data</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">9200:9200</span>
      <span class="pi">-</span> <span class="s">5007:5007</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">elastic</span>

  <span class="na">kibana</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/kibana/kibana:8.4.3</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">kibana</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">5601:5601</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">ELASTICSEARCH_URL</span><span class="pi">:</span> <span class="s">http://es-remote-debug-8-4-3:9200</span>
      <span class="na">ELASTICSEARCH_HOSTS</span><span class="pi">:</span> <span class="s">http://es-remote-debug-8-4-3:9200</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">elastic</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">es_data</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">elastic</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">bridge</span>
</code></pre></div></div>

<p>Após criar o arquivo <code class="language-plaintext highlighter-rouge">docker-compose.yml</code>, vamos rodar o comando para subir os containers:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<p>Pronto! O elastic vai ficar executando localmente com a opção de debug habilitada. Basta agora dar um <code class="language-plaintext highlighter-rouge">Attach to Process</code> em sua IDE de preferência.</p>

<h3 id="debug-no-intellij-idea">Debug no IntelliJ IDEA</h3>

<p>Vamos configurar o projeto do elastic para abrir no IntelliJ.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./gradlew idea
</code></pre></div></div>

<p>Após essa execução basta <a href="https://www.jetbrains.com/help/idea/import-project-or-module-wizard.html#import-project">importar o projeto para o IntelliJ</a>. Após a importação vamos executar novamente:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./gradlew run <span class="nt">--debug-jvm</span>

<span class="c"># ou rodando com o Docker + JAVA_OPTIONS</span>
docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<p>Agora é ir no menu <code class="language-plaintext highlighter-rouge">Run &gt; Debug &gt; Debug Elasticsearch</code>. Se tudo deu certo seu console de debug no IntelliJ vai ter a seguinte menssagem:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Connected to the target VM, address: <span class="s1">'localhost:5007'</span>, transport: <span class="s1">'socket'</span>
</code></pre></div></div>

<p>Para testar se tudo esta funcionando, vamos colocar um breakpoint no arquivo <code class="language-plaintext highlighter-rouge">server/src/main/java/org/elasticsearch/rest/RestController.java</code> na função abaixo:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dispatchRequest</span><span class="o">(</span><span class="nc">RestRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">RestChannel</span> <span class="n">channel</span><span class="o">,</span> <span class="nc">ThreadContext</span> <span class="n">threadContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// COLOCAR BREAKPOINT NESSA LINHA ABAIXO!!!</span>
        <span class="n">threadContext</span><span class="o">.</span><span class="na">addResponseHeader</span><span class="o">(</span><span class="no">ELASTIC_PRODUCT_HTTP_HEADER</span><span class="o">,</span> <span class="no">ELASTIC_PRODUCT_HTTP_HEADER_VALUE</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">tryAllHandlers</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">threadContext</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">channel</span><span class="o">.</span><span class="na">sendResponse</span><span class="o">(</span><span class="k">new</span> <span class="nc">RestResponse</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">e</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">inner</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">inner</span><span class="o">.</span><span class="na">addSuppressed</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"failed to send failure response for uri ["</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">uri</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">,</span> <span class="n">inner</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>Segue o link do arquivo no repositório do github <a href="https://github.com/elastic/elasticsearch/blob/8.4/server/src/main/java/org/elasticsearch/rest/RestController.java#L308">RestController</a></p>

<p>Executamos um curl de teste para a API de <code class="language-plaintext highlighter-rouge">_search</code> e sua IDE deve saltar na tela com o debug travado nessa linha para seguir navegando!</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-u</span> elastic:password localhost:9200/_search
</code></pre></div></div>
<h3 id="debug-no-vscode">Debug no VSCode</h3>

<p>Basta abrir o projeto no VSCode utilizando o comando no seu terminal:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>elasticsearch-debug/elasticsearch
code <span class="nb">.</span>
</code></pre></div></div>

<p>Vamos criar o arquivo de configuração para dar um <code class="language-plaintext highlighter-rouge">Attach to Process</code> via VSCode.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> .vscode/
<span class="nb">touch</span> .vscode/launch.json
</code></pre></div></div>

<p>Agora edite o arquivo <code class="language-plaintext highlighter-rouge">.vscode/launch.json</code> incluindo o conteudo abaixo:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.2.0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"configurations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"java"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Elastic Debug Remote"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"request"</span><span class="p">:</span><span class="w"> </span><span class="s2">"attach"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"hostName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"port"</span><span class="p">:</span><span class="w"> </span><span class="mi">5007</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Abra uma aba do terminal indo menu <code class="language-plaintext highlighter-rouge">Terminal &gt; New Terminal</code> e vamos rodar novamente o comando run do gradlew:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./gradlew run <span class="nt">--debug-jvm</span>

<span class="c"># ou rodando com o Docker + JAVA_OPTIONS</span>
docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<p>Com o projeto rodando, vamos no menu <code class="language-plaintext highlighter-rouge">Run &gt; Start Debugging &gt; Elastic Debug Remote</code>.</p>

<p>Vamos colocar um breakpoint no arquivo <code class="language-plaintext highlighter-rouge">server/src/main/java/org/elasticsearch/rest/RestController.java</code> na função abaixo:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dispatchRequest</span><span class="o">(</span><span class="nc">RestRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">RestChannel</span> <span class="n">channel</span><span class="o">,</span> <span class="nc">ThreadContext</span> <span class="n">threadContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// COLOCAR BREAKPOINT NESSA LINHA ABAIXO!!!</span>
        <span class="n">threadContext</span><span class="o">.</span><span class="na">addResponseHeader</span><span class="o">(</span><span class="no">ELASTIC_PRODUCT_HTTP_HEADER</span><span class="o">,</span> <span class="no">ELASTIC_PRODUCT_HTTP_HEADER_VALUE</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">tryAllHandlers</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">threadContext</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">channel</span><span class="o">.</span><span class="na">sendResponse</span><span class="o">(</span><span class="k">new</span> <span class="nc">RestResponse</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">e</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">inner</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">inner</span><span class="o">.</span><span class="na">addSuppressed</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"failed to send failure response for uri ["</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">uri</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">,</span> <span class="n">inner</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>Segue o link do arquivo no repositório do github <a href="https://github.com/elastic/elasticsearch/blob/8.4/server/src/main/java/org/elasticsearch/rest/RestController.java#L308">RestController</a></p>

<p>Executamos um curl de teste para a API de <code class="language-plaintext highlighter-rouge">_search</code> e sua IDE deve saltar na tela com o debug travado nessa linha para seguir navegando!</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-u</span> elastic:password localhost:9200/_search
</code></pre></div></div>

<h2 id="conclusão">Conclusão</h2>
<p>Debugar sempre é o meu último recurso! É um processo demorado! Prefira sempre documentar a sua aplicação utilizando testes unitários! Para mim esses sim expressam a funcionalidade do sistema e tem mais chances de estarem atualizados (rs…). Porém debugar salva vidas em alguns casos.</p>

<p>Se você chegou até aqui parabéns! Agora é brincar de debugar o projeto do elastic para entender tudo no detalhe e assim poder encontrar bugs e ajudar a manter.</p>

<p>Referências:</p>
<ul>
  <li><a href="https://www.elastic.co/blog/how-to-debug-elasticsearch-source-code-in-intellij-idea">How to Debug Elasticsearch Source Code in IntelliJ IDEA</a></li>
  <li><a href="https://gist.github.com/jconwell/1af41535c5ecd2f4a9dd">jconwell Gist - Remotly Debug ElasticSearch in IntelliJ</a></li>
  <li><a href="https://ocampor.medium.com/development-environment-set-up-for-a-custom-elasticsearch-plugin-266c0df6bbdd">Development Environment Set-up for a Custom Elasticsearch Plugin</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html#docker">Install Elasticsearch with Docker</a></li>
</ul>]]></content><author><name>Raffael Tancman</name></author><category term="elasticsearch" /><summary type="html"><![CDATA[Quem nunca precisou realizar um debug? Essa ferramenta é muito importante para ajudar a entender sistemas e comportamentos inesperados, vulgo bugs!]]></summary></entry><entry><title type="html">Elasticsearch &amp;amp; Spark</title><link href="https://www.rtancman.com.br/elasticsearch/elasticsearch-spark-ingestao-de-dados.html" rel="alternate" type="text/html" title="Elasticsearch &amp;amp; Spark" /><published>2022-08-17T09:00:00+00:00</published><updated>2022-08-17T09:00:00+00:00</updated><id>https://www.rtancman.com.br/elasticsearch/elasticsearch-spark-ingestao-de-dados</id><content type="html" xml:base="https://www.rtancman.com.br/elasticsearch/elasticsearch-spark-ingestao-de-dados.html"><![CDATA[<p>Recentemente me deparei com o problema de ter que processar um arquivão (muito comum no dia a dia) e fazer algumas operações. Logo em seguida, salvar o resultado em um indice do elasticsearch. Nesses casos eu recorro sempre ao <a href="https://spark.apache.org/">Apache Spark</a> e pensei será que não existe algum cliente para colocar isso de maneira otimizada no elastic? E como sempre o google me respondeu temos sim e se chama <a href="https://github.com/elastic/elasticsearch-hadoop">elasticsearch-hadoop</a>. Olhando a <a href="https://www.elastic.co/guide/en/elasticsearch/hadoop/current/spark.html#spark-sql-write">Doc</a>, fui testar na prática e em alguns casos tive uns comportamentos inesperados, principalmente utilizando <a href="https://spark.apache.org/docs/latest/sql-programming-guide.html">Dataframes</a>.</p>

<p>O Spark tem uma API muito boa para lidar com leitura e escrita de Dataframes, ou seja quero usar dessa forma! Googlando um pouquinho mais acabei encontrando na <a href="https://docs.databricks.com/data/data-sources/elasticsearch.html">documentação do Databricks</a> a forma “certa” de ser fazer. Hoje vou compartilhar com vocês este aprendizado, vamos lá!</p>

<h2 id="configurando-o-ambiente-de-trabalho">Configurando o ambiente de trabalho</h2>

<p>Quando trabalho no universo JVM recomendo utilizar o <a href="https://sdkman.io/">sdkman</a> para gerenciar as diversas versões de java, scala, sbt e por aê vai.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># instalando o sdkman</span>
curl <span class="nt">-s</span> <span class="s2">"https://get.sdkman.io"</span> | bash


<span class="c"># instalando versões da jdk, scala, sbt</span>
sdk <span class="nb">install </span>8.0.275.hs-adpt
sdk use java 8.0.275.hs-adpt

sdk <span class="nb">install </span>scala 2.12.16
sdk use scala 2.12.16

sdk <span class="nb">install </span>sbt 1.7.1
sdk use sbt 1.7.1
</code></pre></div></div>

<h2 id="compilando-o-projeto">Compilando o projeto</h2>

<p>Com o ambiente pronto, agora vamos criar o nosso projeto, e eu recomendo utilizar o comando <a href="https://www.scala-sbt.org/1.x/docs/sbt-new-and-Templates.html">sbt new ALGUMA_TEMPLATE_QUALQUER</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbt new scala/scala-seed.g8
</code></pre></div></div>

<p>Agora que temos a estrutura do projeto criada, vamos compilar para saber se tudo esta ok!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbt compile
sbt run
</code></pre></div></div>

<p>Se tudo deu certo iremos visualizar o seguinte output:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>sbt run
<span class="o">[</span>info] welcome to sbt 1.7.1 <span class="o">(</span>Oracle Corporation Java 17.0.2<span class="o">)</span>
<span class="o">[</span>info] loading global plugins from /Users/MEU_USUARIO/.sbt/1.0/plugins
<span class="o">[</span>info] loading project definition from /Users/MEU_USUARIO/elasticsearch-spark/project
<span class="o">[</span>info] loading settings <span class="k">for </span>project root from build.sbt ...
<span class="o">[</span>info] <span class="nb">set </span>current project to lala <span class="o">(</span><span class="k">in </span>build file:/Users/MEU_USUARIO/elasticsearch-spark/<span class="o">)</span>
<span class="o">[</span>info] running example.Hello
hello
</code></pre></div></div>

<h2 id="criando-o-nosso-pacote-método-main-e-adicionando-as-dependências">Criando o nosso pacote, método main e adicionando as dependências</h2>

<p>Agora vamos criar os nossos exemplos em scala.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>project
<span class="nb">mkdir</span> <span class="nt">-p</span> src/main/scala/br/com/rtancman/
<span class="nb">touch </span>src/main/scala/br/com/rtancman/ElasticsearchSpark.scala
<span class="nb">touch </span>project/plugins.sbt
<span class="nb">touch </span>docker-compose.yml
</code></pre></div></div>

<p>Edite o arquivo <code class="language-plaintext highlighter-rouge">src/main/scala/br/com/rtancman/ElasticsearchSpark.scala</code> com o conteudo abaixo:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">br.com.rtancman</span>

<span class="k">import</span> <span class="nn">org.apache.spark.sql.</span><span class="o">{</span><span class="nc">SparkSession</span><span class="o">,</span> <span class="nc">Row</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.types.</span><span class="o">{</span><span class="nc">StringType</span><span class="o">,</span> <span class="nc">StructField</span><span class="o">,</span> <span class="nc">StructType</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions._</span>
<span class="k">import</span> <span class="nn">scala.collection.JavaConversions._</span>

<span class="k">object</span> <span class="nc">ElasticsearchSpark</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">spark</span> <span class="k">=</span> <span class="nc">SparkSession</span>
      <span class="o">.</span><span class="py">builder</span><span class="o">()</span>
      <span class="o">.</span><span class="py">appName</span><span class="o">(</span><span class="s">"elasticsearch-spark-example-1"</span><span class="o">)</span>
      <span class="o">.</span><span class="py">master</span><span class="o">(</span><span class="s">"local[*]"</span><span class="o">)</span>
      <span class="o">.</span><span class="py">config</span><span class="o">(</span><span class="s">"es.nodes"</span><span class="o">,</span> <span class="s">"localhost"</span><span class="o">)</span>
      <span class="o">.</span><span class="py">config</span><span class="o">(</span><span class="s">"es.port"</span><span class="o">,</span> <span class="s">"9200"</span><span class="o">)</span>
      <span class="o">.</span><span class="py">getOrCreate</span><span class="o">()</span>

    <span class="k">import</span> <span class="nn">spark.implicits._</span>

    <span class="k">val</span> <span class="nv">schemaMovie</span> <span class="k">=</span> <span class="nc">StructType</span><span class="o">(</span>
      <span class="nc">Array</span><span class="o">(</span>
        <span class="nc">StructField</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span>
        <span class="nc">StructField</span><span class="o">(</span><span class="s">"type"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">)</span>
      <span class="o">)</span>
    <span class="o">)</span>
    <span class="k">val</span> <span class="nv">rowMovie</span><span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="nc">Row</span><span class="o">(</span><span class="s">"Matrix"</span><span class="o">,</span> <span class="s">"movie"</span><span class="o">),</span> <span class="nc">Row</span><span class="o">(</span><span class="s">"John Wick"</span><span class="o">,</span> <span class="s">"movie"</span><span class="o">))</span>

    <span class="k">val</span> <span class="nv">df</span> <span class="k">=</span> <span class="nv">spark</span><span class="o">.</span><span class="py">createDataFrame</span><span class="o">(</span><span class="n">rowMovie</span><span class="o">,</span> <span class="n">schemaMovie</span><span class="o">)</span>

    <span class="nv">df</span><span class="o">.</span><span class="py">write</span>
      <span class="o">.</span><span class="py">format</span><span class="o">(</span><span class="s">"org.elasticsearch.spark.sql"</span><span class="o">)</span>
      <span class="o">.</span><span class="py">option</span><span class="o">(</span><span class="s">"es.resource"</span><span class="o">,</span> <span class="s">"elasticsearch-spark-small-movies"</span><span class="o">)</span>
      <span class="o">.</span><span class="py">option</span><span class="o">(</span><span class="s">"es.write.operation"</span><span class="o">,</span> <span class="s">"upsert"</span><span class="o">)</span>
      <span class="o">.</span><span class="py">option</span><span class="o">(</span><span class="s">"es.index.auto.create"</span><span class="o">,</span> <span class="s">"true"</span><span class="o">)</span>
      <span class="o">.</span><span class="py">option</span><span class="o">(</span><span class="s">"es.nodes.wan.only"</span><span class="o">,</span> <span class="s">"true"</span><span class="o">)</span>
      <span class="o">.</span><span class="py">option</span><span class="o">(</span><span class="s">"es.mapping.id"</span><span class="o">,</span> <span class="s">"id"</span><span class="o">)</span>
      <span class="o">.</span><span class="py">option</span><span class="o">(</span><span class="s">"es.spark.dataframe.write.null"</span><span class="o">,</span> <span class="s">"true"</span><span class="o">)</span>
      <span class="o">.</span><span class="py">save</span><span class="o">()</span>

    <span class="nv">spark</span><span class="o">.</span><span class="py">close</span><span class="o">()</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Vamos incluir as dependências. Para isto vamos precisar editar 3 arquivos <code class="language-plaintext highlighter-rouge">project/Dependencies.scala</code>, <code class="language-plaintext highlighter-rouge">build.sbt</code> e <code class="language-plaintext highlighter-rouge">project/plugins.sbt</code> com o conteúdo abaixo:</p>

<p>Arquivo <code class="language-plaintext highlighter-rouge">project/Dependencies.scala</code>:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">sbt._</span>

<span class="k">object</span> <span class="nc">Dependencies</span> <span class="o">{</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="nv">scalaTest</span> <span class="k">=</span> <span class="s">"org.scalatest"</span> <span class="o">%%</span> <span class="s">"scalatest"</span> <span class="o">%</span> <span class="s">"3.2.11"</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="nv">spark</span> <span class="k">=</span> <span class="s">"org.apache.spark"</span> <span class="o">%%</span> <span class="s">"spark-core"</span> <span class="o">%</span> <span class="s">"3.2.2"</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="nv">sparkSql</span> <span class="k">=</span> <span class="s">"org.apache.spark"</span> <span class="o">%%</span> <span class="s">"spark-sql"</span> <span class="o">%</span> <span class="s">"3.2.2"</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="nv">elasticSpark</span> <span class="k">=</span>
    <span class="s">"org.elasticsearch"</span> <span class="o">%</span> <span class="s">"elasticsearch-spark-30_2.12"</span> <span class="o">%</span> <span class="s">"8.3.3"</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">ExcludeDependencies</span> <span class="o">{</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="nv">sparkCore2_11</span> <span class="k">=</span> <span class="s">"org.apache.spark"</span> <span class="o">%</span> <span class="s">"spark-core_2.11"</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="nv">sparkSQL2_11</span> <span class="k">=</span> <span class="s">"org.apache.spark"</span> <span class="o">%</span> <span class="s">"spark-sql_2.11"</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="nv">sparkYarn2_11</span> <span class="k">=</span> <span class="s">"org.apache.spark"</span> <span class="o">%</span> <span class="s">"spark-yarn_2.11"</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="nv">sparkStreaming2_11</span> <span class="k">=</span> <span class="s">"org.apache.spark"</span> <span class="o">%</span> <span class="s">"spark-streaming_2.11"</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Arquivo <code class="language-plaintext highlighter-rouge">build.sbt</code>:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">Dependencies._</span>
<span class="k">import</span> <span class="nn">ExcludeDependencies._</span>

<span class="nc">ThisBuild</span> <span class="o">/</span> <span class="n">scalaVersion</span> <span class="o">:=</span> <span class="s">"2.12.16"</span>
<span class="nc">ThisBuild</span> <span class="o">/</span> <span class="n">version</span> <span class="o">:=</span> <span class="s">"1.0.0"</span>
<span class="nc">ThisBuild</span> <span class="o">/</span> <span class="n">organization</span> <span class="o">:=</span> <span class="s">"br.com.rtancman"</span>
<span class="nc">ThisBuild</span> <span class="o">/</span> <span class="n">organizationName</span> <span class="o">:=</span> <span class="s">"rtancman"</span>
<span class="nc">ThisBuild</span> <span class="o">/</span> <span class="n">assembly</span> <span class="o">/</span> <span class="n">assemblyMergeStrategy</span> <span class="o">:=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">PathList</span><span class="o">(</span><span class="s">"META-INF"</span><span class="o">,</span> <span class="k">_</span><span class="o">*)</span> <span class="k">=&gt;</span> <span class="nv">MergeStrategy</span><span class="o">.</span><span class="py">discard</span>
  <span class="k">case</span> <span class="s">"application.conf"</span>       <span class="k">=&gt;</span> <span class="nv">MergeStrategy</span><span class="o">.</span><span class="py">concat</span>
  <span class="k">case</span> <span class="s">"reference.conf"</span>         <span class="k">=&gt;</span> <span class="nv">MergeStrategy</span><span class="o">.</span><span class="py">concat</span>
  <span class="k">case</span> <span class="k">_</span>                        <span class="k">=&gt;</span> <span class="nv">MergeStrategy</span><span class="o">.</span><span class="py">first</span>
<span class="o">}</span>

<span class="k">lazy</span> <span class="k">val</span> <span class="nv">root</span> <span class="k">=</span> <span class="o">(</span><span class="n">project</span> <span class="n">in</span> <span class="nf">file</span><span class="o">(</span><span class="s">"."</span><span class="o">))</span>
  <span class="o">.</span><span class="py">settings</span><span class="o">(</span>
    <span class="n">name</span> <span class="o">:=</span> <span class="s">"rtancman-elastic-spark-examples"</span><span class="o">,</span>
    <span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
      <span class="n">scalaTest</span> <span class="o">%</span> <span class="nc">Test</span><span class="o">,</span>
      <span class="n">elasticSpark</span><span class="o">,</span>
      <span class="n">spark</span><span class="o">,</span>
      <span class="n">sparkSql</span>
    <span class="o">),</span>
    <span class="n">excludeDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
      <span class="n">sparkCore2_11</span><span class="o">,</span>
      <span class="n">sparkSQL2_11</span><span class="o">,</span>
      <span class="n">sparkYarn2_11</span><span class="o">,</span>
      <span class="n">sparkStreaming2_11</span>
    <span class="o">)</span>
  <span class="o">)</span>
</code></pre></div></div>

<p>Arquivo <code class="language-plaintext highlighter-rouge">project/plugins.sbt</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">addSbtPlugin</span><span class="o">(</span><span class="s">"com.eed3si9n"</span> <span class="o">%</span> <span class="s">"sbt-assembly"</span> <span class="o">%</span> <span class="s">"1.2.0"</span><span class="o">)</span>
</code></pre></div></div>

<p>Vamos testar se tudo esta ok rodando <code class="language-plaintext highlighter-rouge">sbt compile</code>. Devemos ter o seguinte resultado:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>success] Total <span class="nb">time</span>: 4 s, completed Aug 17, 2022, 4:44:51 PM
</code></pre></div></div>

<h2 id="instalando-o-spark-e-elasticsearch">Instalando o spark e elasticsearch</h2>

<p>Para executar este programa precisamos de um cluster spark e do elasticsearch. Começando com o setup do spark:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://archive.apache.org/dist/spark/spark-3.2.2/spark-3.2.2-bin-hadoop2.7.tgz
<span class="nb">tar </span>x spark-3.2.2-bin-hadoop2.7.tgz
<span class="nb">export </span><span class="nv">SPARK_HOME</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/spark-3.2.2-bin-hadoop2.7
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$SPARK_HOME</span>:<span class="nv">$SPARK_HOME</span>/bin:<span class="nv">$SPARK_HOME</span>/sbin
<span class="c"># test</span>
spark-shell
</code></pre></div></div>

<p>Para o elasticsearch, vamos subir com o docker-compose. Edite o arquivo <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> com o conteúdo abaixo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: <span class="s1">'3'</span>
services:
  elasticsearch:
    image: us.gcr.io/jusbrasil-155317/jusbrasil/scooby-tenx-elastic-iteration-test-base:8.3.3
    container_name: elasticsearch_spark
    ports:
      - <span class="s2">"9200:9200"</span>
      - <span class="s2">"9300:9300"</span>
    environment:
      - discovery.type<span class="o">=</span>single-node
      - xpack.security.enabled<span class="o">=</span><span class="nb">false</span>
      - <span class="s2">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span>
    networks:
      - elasticsearch_spark

  kibana:
    image: docker.elastic.co/kibana/kibana:8.3.3
    ports:
      - <span class="s2">"5601:5601"</span>
    environment:
      ELASTICSEARCH_URL: http://elasticsearch_spark:9200
      ELASTICSEARCH_HOSTS: http://elasticsearch_spark:9200
    networks:
      - elasticsearch_spark

volumes:
  es_data:
    driver: <span class="nb">local

</span>networks:
  elasticsearch_spark:
    driver: bridge
</code></pre></div></div>

<h2 id="executando-o-programa">Executando o programa</h2>

<p>Para rodar este spark job, vamos subir o elastic, compilar o nosso projeto gerando um .jar e rodar o comando spark-submit.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up <span class="nt">-d</span>

sbt assembly

spark-submit <span class="se">\</span>
  <span class="nt">--class</span> br.com.rtancman.ElasticsearchSpark <span class="se">\</span>
  target/scala-2.12/rtancman-elastic-spark-examples-assembly-1.0.0.jar
</code></pre></div></div>

<h2 id="verificando-no-kibana-os-valores-indexados">Verificando no kibana os valores indexados</h2>

<p>Nosso docker-compose tem uma imagem do kibana e podemos acessar a url <a href="http://localhost:5601/app/dev_tools">http://localhost:5601/app/dev_tools</a> para realizar queries no elasticsearch.</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">GET /_cat/indices

GET /elasticsearch-spark-small-movies/_search
</span></code></pre></div></div>

<p>Se tudo correu conforme o esperado o seu resultado deve ser:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nl">"relation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eq"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"elasticsearch-spark-small-movies"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"John Wick"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"movie"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"elasticsearch-spark-small-movies"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Matrix"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"movie"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="conclusão">Conclusão</h2>

<p>Spark e Elasticsearch são duas ferramentas poderosas e neste artigo busquei detalhar como podemos trabalhar com elas em conjunto para gerar valor no nosso dia a dia.</p>

<p>Referências:</p>
<ul>
  <li><a href="https://docs.databricks.com/data/data-sources/elasticsearch.html">ElasticSearch - Data ingestion Doc by Databrics</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/hadoop/current/spark.html">Elastic - Apache Spark Support</a></li>
  <li><a href="https://docs.databricks.com/data/data-sources/elasticsearch.html">Writing a Spark Dataframe to an Elasticsearch Index</a></li>
</ul>]]></content><author><name>Raffael Tancman</name></author><category term="elasticsearch" /><summary type="html"><![CDATA[Recentemente me deparei com o problema de ter que processar um arquivão (muito comum no dia a dia) e fazer algumas operações. Logo em seguida, salvar o resultado em um indice do elasticsearch. Nesses casos eu recorro sempre ao Apache Spark e pensei será que não existe algum cliente para colocar isso de maneira otimizada no elastic? E como sempre o google me respondeu temos sim e se chama elasticsearch-hadoop. Olhando a Doc, fui testar na prática e em alguns casos tive uns comportamentos inesperados, principalmente utilizando Dataframes.]]></summary></entry><entry><title type="html">Kubernetes para iniciantes - Parte 2</title><link href="https://www.rtancman.com.br/kubernetes/kubernetes-para-iniciantes-parte-2.html" rel="alternate" type="text/html" title="Kubernetes para iniciantes - Parte 2" /><published>2020-07-25T11:51:00+00:00</published><updated>2020-07-25T11:51:00+00:00</updated><id>https://www.rtancman.com.br/kubernetes/kubernetes-para-iniciantes-parte-2</id><content type="html" xml:base="https://www.rtancman.com.br/kubernetes/kubernetes-para-iniciantes-parte-2.html"><![CDATA[<p>Este artigo é a continuação do nosso wordpress rodando no k8s. Caso você não tenha acessado a primeira parte, <a href="https://www.rtancman.com.br/kubernetes/kubernetes-para-iniciantes.html">clique aqui</a> para entender o que é k8s, quais são seus principais comandos e como subir um wordpress.</p>

<p>Neste artigo vamos evoluir o nosso projeto do wordpress aplicando Secrets, Configmap e Volumes. Vamos iniciar alterando o nosso Deployment para utilizar o Configmap e Secrets.</p>

<h3 id="configmap-e-secrets-na-prática">Configmap e Secrets na prática</h3>

<p>No nosso manifesto atual estamos incluindo as variáveis de ambiente todas no manifesto. Isso não é errado, mas quando se trata de configurações que podem ser compartilhadas entre outros pods o ideal é a gente centralizar essas informações em um manifesto em si. O Configmap vai nos ajudar nesse sentido. Vamos criar o nosso e aplicar essa alteração no Deployment.</p>

<p>Crie o arquivo wp-configmap.yaml com o seguinte conteúdo abaixo:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-configmap</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">WORDPRESS_DB_HOST</span><span class="pi">:</span> <span class="s2">"</span><span class="s">mariadb-service"</span>
  <span class="na">WORDPRESS_DB_PORT</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3306"</span>
  <span class="na">WORDPRESS_DB_NAME</span><span class="pi">:</span> <span class="s2">"</span><span class="s">wp-k8s"</span>
</code></pre></div></div>

<p>Agora podemos rodar o apply e verificar se tudo esta funcionando.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> wp-configmap.yaml
kubectl get configmap

<span class="c"># resultado</span>
NAME DATA AGE
meu-blog-escalavel-configmap 2 11m

<span class="c"># rodando o describe</span>
kubectl describe configmap meu-blog-escalavel-configmap
</code></pre></div></div>

<p>Vamos aplicar essas variáveis no nosso deployment e para isso existem diversas formas de aplicar essa configuração e recomendo a leitura da <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#use-configmap-defined-environment-variables-in-pod-commands">documentação aqui</a>. Altere o arquivo wp-deployment.yaml com o seguinte conteúdo abaixo:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">wordpress-escalavel</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">wordpress-escalavel</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">wordpress-escalavel</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">wordpress:5.4.2-php7.2-apache</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_USER</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">wp-user</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_PASSWORD</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">q1w2e3r4</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_HOST</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">configMapKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-configmap</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_HOST</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_PORT</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">configMapKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-configmap</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_PORT</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_NAME</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">configMapKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-configmap</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_NAME</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<p>Iremos agora alterar o Deployment do nosso banco mariaDB. Altere o arquivo wp-mariadb.yaml com o seguinte conteúdo abaixo:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">Recreate</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">rtancman/mariadb-local</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Always"</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">adminroot</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_USER</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">wp-user</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_PASSWORD</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">q1w2e3r4</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_DATABASE</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">configMapKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-configmap</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_NAME</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">3306</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
</code></pre></div></div>

<p>Agora basta aplicar as alterações. Vamos lá!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> wp-deployment.yaml
kubectl apply <span class="nt">-f</span> wp-mariadb.yaml
</code></pre></div></div>

<p>Pronto! Agora toda vez que alterar o valor do ConfigMap essas variáveis vão ser aplicadas nos nossos deployments. Ainda precisamos acertar as credenciais de acesso e para isso vamos utilizar o <a href="https://kubernetes.io/docs/concepts/configuration/secret/">Secret</a>.</p>

<p>Antes de criar o arquivo vamos precisar colocar os valores de login e senha do banco em base64 encode.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="nt">-n</span>  <span class="s2">"adminroot"</span> | <span class="nb">base64</span>
<span class="c">#resultado</span>
YWRtaW5yb290

<span class="nb">echo</span> <span class="nt">-n</span>  <span class="s2">"wp-user"</span> | <span class="nb">base64</span>
<span class="c">#resultado</span>
<span class="nv">d3AtdXNlcg</span><span class="o">==</span>

<span class="nb">echo</span> <span class="nt">-n</span>  <span class="s2">"q1w2e3r4"</span> | <span class="nb">base64</span>
<span class="c">#resultado</span>
<span class="nv">cTF3MmUzcjQ</span><span class="o">=</span>
</code></pre></div></div>

<p>Agora é criar o nosso manifesto e para isso vamos criar o arquivo wp-secrets.yaml com o seguinte conteúdo abaixo:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-secrets</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">Opaque</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">mariadb_username</span><span class="pi">:</span> <span class="s">d3AtdXNlcg==</span>
  <span class="na">mariadb_password</span><span class="pi">:</span> <span class="s">cTF3MmUzcjQ=</span>
  <span class="na">mariadb_root_password</span><span class="pi">:</span> <span class="s">YWRtaW5yb290</span>
</code></pre></div></div>

<p>Vamos aplicar e verificar as configurações.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> wp-secrets.yaml
kubectl get secrets meu-blog-escalavel-secrets
<span class="c">#resultado</span>
NAME TYPE DATA AGE
meu-blog-escalavel-secrets Opaque 3 9s

kubectl describe secrets meu-blog-escalavel-secrets
</code></pre></div></div>

<p>Após subir essa configuração, vamos aplicar os secrets em nossos deployments. Altere o arquivo wp-deployment.yaml com o seguinte conteúdo abaixo:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">wordpress-escalavel</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">wordpress-escalavel</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">wordpress-escalavel</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">wordpress:5.4.2-php7.2-apache</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_USER</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-secrets</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">mariadb_username</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_PASSWORD</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-secrets</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">mariadb_password</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_HOST</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">configMapKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-configmap</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_HOST</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_PORT</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">configMapKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-configmap</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_PORT</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_NAME</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">configMapKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-configmap</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_NAME</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<p>E precisamos alterar o arquivo wp-mariadb.yaml com o seguinte conteúdo abaixo:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">Recreate</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">rtancman/mariadb-local</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Always"</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_USER</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-secrets</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">mariadb_username</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_PASSWORD</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-secrets</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">mariadb_password</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-secrets</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">mariadb_root_password</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_DATABASE</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">configMapKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-configmap</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_NAME</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">3306</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
</code></pre></div></div>

<p>Com os manifestos alterados vamos aplicar essa nova configuração.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> wp-deployment.yaml
kubectl apply <span class="nt">-f</span> wp-mariadb.yaml
</code></pre></div></div>

<p>Pronto! Nossos deployments agora estão configurados utilizando ConfigMap e Secrets. Com isso aplicamos boas práticas em nosso manifesto. Agora vamos aplicar o PersistentVolume e fazer com que a nossa base do mariaDB não seja destruida a cada restart dos pods.</p>

<h2 id="persistent-volume">Persistent Volume</h2>

<p>Diferentemente dos outros deployments, como este é um banco de dados e não queremos perder as suas informações a cada restart do pod, vamos criar um volume. E para isso vamos alterar o nosso manifesto para incluir a configuração de volumes. Aqui utilizamos o tipo <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistent-volumes">PersistentVolume</a> e <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">PersistentVolumeClaim</a>.</p>

<p>Crie o arquivo wp-mariadb-pv.yaml com o seguinte conteúdo abaixo:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolume</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-pv-volume</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">local</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">capacity</span><span class="pi">:</span>
    <span class="na">storage</span><span class="pi">:</span> <span class="s">20Gi</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="na">hostPath</span><span class="pi">:</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/mnt/data"</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolumeClaim</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-pv-claim</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">20Gi</span>
</code></pre></div></div>

<p>Neste aquivo acima estamos criando 2 objetos no k8s que são PersistentVolume e o PersistentVolumeClaim. O k8s permite essa formatação incluindo o delimitador — defindo onde termina o manifesto. Agora vamos aplicar o nosso volume no Deployment do mariadb.</p>

<p>Alterar o arquivo wp-mariadb.yaml com o seguinte conteúdo abaixo:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">Recreate</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">rtancman/mariadb-local</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Always"</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_USER</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-secrets</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">mariadb_username</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_PASSWORD</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-secrets</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">mariadb_password</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-secrets</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">mariadb_root_password</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_DATABASE</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">configMapKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-configmap</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_NAME</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">3306</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-persistent-storage</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/lib/mysql</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-persistent-storage</span>
        <span class="na">persistentVolumeClaim</span><span class="pi">:</span>
          <span class="na">claimName</span><span class="pi">:</span> <span class="s">mariadb-pv-claim</span>
</code></pre></div></div>

<p>Com isso, vamos executar os comandos de apply.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> wp-mariadb-pv.yaml
kubectl apply <span class="nt">-f</span> wp-mariadb.yaml

<span class="c"># verificando os nossos volumes</span>
kubectl get pvc mariadb-pv-claim
kubectl get pv mariadb-pv-volume
</code></pre></div></div>

<p>Pronto! Com isso agora podemos restart o nosso deployment sem problemas que a nossa base de dados não vai ser mais removida devido ao volume que criamos. Ainda sim podemos melhor esse manifesto do mariadb. Nesses casos que precisamos de um volume para manter a consistência dos nossos deployments o ideal é utilizar o objeto <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/">StatefulSets</a>. Vamos as alterações em nosso manifesto.</p>

<p>Vamos criar um novo arquivo wp-mariadb-statefullsets.yaml com o seguinte conteúdo abaixo:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">StatefulSet</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
  <span class="na">serviceName</span><span class="pi">:</span> <span class="s">mariadb-service</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">rtancman/mariadb-local</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Always"</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_USER</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-secrets</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">mariadb_username</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_PASSWORD</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-secrets</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">mariadb_password</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-secrets</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">mariadb_root_password</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_DATABASE</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">configMapKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-configmap</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_NAME</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">3306</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-persistent-storage</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/lib/mysql</span>
  <span class="na">volumeClaimTemplates</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">metadata</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-persistent-storage</span>
      <span class="na">spec</span><span class="pi">:</span>
        <span class="na">accessModes</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">ReadWriteOnce"</span> <span class="pi">]</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">storage</span><span class="pi">:</span> <span class="s">20Gi</span>
</code></pre></div></div>

<p>Com essa configuração volumeClaimTemplates toda vez que você subir um novo statefullset ou der um scale nesse objeto, o k8s vai criar um novo volume seguindo a especificação do manifesto. Agora vamos executar os comandos.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># vamos apagar as configurações passadas</span>
kubectl delete deployments mariadb-wp
kubectl delete pvc mariadb-pv-claim
kubectl delete pv mariadb-pv-volume

kubectl apply <span class="nt">-f</span> wp-mariadb-statefullsets.yaml
<span class="c"># verificando os nossos volumes</span>
kubectl get pvc mariadb-pv-claim
kubectl get pv mariadb-pv-volume
</code></pre></div></div>

<p>Pronto agora temos o nosso mariadb como statefullset! Mais uma vez parabéns se você chegou até aqui e podemos dizer que o básico sobre Secrets, ConfigMap e Volumes no k8s você acabou de aprender. Leia a documentação e faça os tutoriais no site do k8s para continuar praticando. Todo este código esta no github no repositorio <a href="https://github.com/rtancman/k8s-examples">rtancman/k8s-examples</a>.</p>

<p>Grande abraço!</p>]]></content><author><name>Raffael Tancman</name></author><category term="kubernetes" /><summary type="html"><![CDATA[Este artigo é a continuação do nosso wordpress rodando no k8s. Caso você não tenha acessado a primeira parte, clique aqui para entender o que é k8s, quais são seus principais comandos e como subir um wordpress.]]></summary></entry><entry><title type="html">Elasticsearch como ferramenta de busca</title><link href="https://www.rtancman.com.br/elasticsearch/elasticsearch-como-ferramenta-de-busca.html" rel="alternate" type="text/html" title="Elasticsearch como ferramenta de busca" /><published>2020-06-30T11:51:00+00:00</published><updated>2020-06-30T11:51:00+00:00</updated><id>https://www.rtancman.com.br/elasticsearch/elasticsearch-como-ferramenta-de-busca</id><content type="html" xml:base="https://www.rtancman.com.br/elasticsearch/elasticsearch-como-ferramenta-de-busca.html"><![CDATA[<p>Boa parte dos sistemas tem uma ferramenta de busca e a forma como a mesma é implementada pode variar. Faz sentido utilizar o banco de dados atual da aplicação e começar a aplicar algumas features de busca, mas isso pode ser um tiro no pé quando você quer de fato entregar o melhor documento dada uma determinada busca. Nesses casos, o elasticsearch é a ferramenta que vai trazer documentos relevantes para um resultado de busca. Vamos entender nesse artigo o que é essa ferramenta e executar os principais comandos do dia a dia. No final iremos subir um cluster no docker e ver a parte de monitoramento utilizando o kibana.</p>

<h3 id="o-que-é-o-elasticsearch">O que é o elasticsearch?</h3>

<p>É um sistema de busca distribuído baseado no Apache Lucene. A sua API Rest é simples e robusta. Além disso, é uma ferramenta completa, veloz e de escalabilidade distribuída. Foi lançado pela primeira vez em 2010 pela Elasticsearch e é uma ferramenta de alta confiabilidade e robustez. Muitas empresas utilizam essa ferramenta e já vi por lugares que passei diversas soluções sendo criadas com ele.</p>

<p>Um dos motivos da sua velocidade é o <a href="https://en.wikipedia.org/wiki/Inverted_index">índice invertido</a>. Que é projetado para permitir buscas de texto completo muito rápidas. Um índice invertido lista cada palavra exclusiva que apareça em qualquer documento e identifica todos os documentos em que cada palavra aparece. <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/documents-indices.html">Nesta sessão da documentação</a> do elasticsearch temos mais detalhes de porque ele é rápido e como essa distribuição acontece.</p>

<p>Agora focando na relevância dos documentos retornados no resultado, elasticsearch utiliza algoritmos de similaridade para criar um score único e com esse valor ele ordena os resultados dos mais relevantes para os menos relevantes baseado em uma query feita pelo usuário. Por default a partir da versão 7, utiliza o <a href="https://en.wikipedia.org/wiki/Okapi_BM25">BM25</a> que é uma função de ranking para calcular quão importante cada documento. Além do BM25 existem outros algoritmos e você pode ver nessa sessão da documentação <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules-similarity.html">“Similarity module”</a> mas o atual da conta recado é um dos melhores algoritmos de ranking.</p>

<p>Recomendo a leitura da documentação da ferramenta para maior entendimento de como as coisa funcionam por debaixo dos panos e principalmente para entender como funciona a análise de textos que você pode acessar aqui nessa sessão de <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis.html#analysis">“Text analysis”</a> . Vamos entender na prática como podemos interagir com essa ferramenta e quão simples e subir um cluster.</p>

<h3 id="rodando-o-elasticsearch-localmente">Rodando o elasticsearch localmente</h3>

<p>O elasticsearch como é uma solução construída em Java, você basicamente precisa baixar o mesmo e rodar localmente. Eu recomendo sempre utilizar os gerenciadores de pacotes do seu SO para realizar essa instalação. Mas para esse artigo vamos utilizar o docker e docker-compose para facilitar todo o setup. Então vamos entender o que vamos instalar que serão as seguintes ferramentas:</p>

<ul>
  <li>Elasticsearch: Que é o sistema de busca.</li>
  <li>Kibana: É o cliente para gerenciar o elasticsearch além de ter ferramentas de monitoramento e um cliente rico para rodar queries no elastic.</li>
</ul>

<p>Vamos a configuração do arquivo docker-compose.yml:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2.2'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">es</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/elasticsearch/elasticsearch:7.8.0</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">es</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">node.name=es</span>
      <span class="pi">-</span> <span class="s">cluster.name=es-docker-cluster</span>
      <span class="pi">-</span> <span class="s">discovery.seed_hosts=es</span>
      <span class="pi">-</span> <span class="s">cluster.initial_master_nodes=es</span>
      <span class="pi">-</span> <span class="s">bootstrap.memory_lock=true</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">ES_JAVA_OPTS=-Xms512m</span><span class="nv"> </span><span class="s">-Xmx512m"</span>
    <span class="na">ulimits</span><span class="pi">:</span>
      <span class="na">memlock</span><span class="pi">:</span>
        <span class="na">soft</span><span class="pi">:</span> <span class="s">-1</span>
        <span class="na">hard</span><span class="pi">:</span> <span class="s">-1</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">es_data:/usr/share/elasticsearch/data</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">9200:9200</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">elastic</span>

  <span class="na">kibana</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/kibana/kibana:7.8.0</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">kibana</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">5601:5601</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">ELASTICSEARCH_URL</span><span class="pi">:</span> <span class="s">http://es:9200</span>
      <span class="na">ELASTICSEARCH_HOSTS</span><span class="pi">:</span> <span class="s">http://es:9200</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">elastic</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">es_data</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">elastic</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">bridge</span>
</code></pre></div></div>

<p>Essa configuração foi feita com base na documentação do elasticsearch <a href="https://www.elastic.co/guide/en/elastic-stack-get-started/current/get-started-docker.html">“Running the Elastic Stack on Docker”</a> e simplifiquei por hora para a gente entender como as coisas funcionam. Agora podemos executar o comando docker-compose up.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<p>Agora com a aplicação rodando podemos acessar o kibana pela url <a href="http://localhost:5601/">http://localhost:5601/</a>. Pode ser que demore um pouquinho para subir e você pode conferir se tudo está funcionando verificando se os containers estão de pé. Para isso basta executar:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># containers que estão rodando</span>
<span class="nv">$ </span>docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
011da05e9bd2 docker.elastic.co/elasticsearch/elasticsearch:7.8.0 <span class="s2">"/tini -- /usr/local..."</span> 4 hours ago Up 4 hours 0.0.0.0:9200-&gt;9200/tcp, 9300/tcp es01
961846fb5ae6 docker.elastic.co/kibana/kibana:7.8.0 <span class="s2">"/usr/local/bin/dumb..."</span> 4 hours ago Up 4 hours 0.0.0.0:5601-&gt;5601/tcp kib01

<span class="c"># para ver os logs</span>
<span class="nv">$ </span>docker logs es01
<span class="nv">$ </span>docker logs kib01

<span class="c"># checando o servico elasticsearch</span>
<span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="s2">"localhost:9200/_cat/indices?v&amp;pretty"</span>
health status index uuid pri rep docs.count docs.deleted store.size pri.store.size
green open .kibana-event-log-7.8.0-000001 7fJFAISuQRaEqZcWLBH7oA 1 0 3 0 15.5kb 15.5kb
green open .apm-custom-link BijrW0OUQOOw7RSGJcz9HA 1 0 0 0 208b 208b
green open .kibana_task_manager_1 FvG7WnppQ6WioFlyQTF17Q 1 0 5 0 14.1kb 14.1kb
green open .apm-agent-configuration Qh9Ye6CgSMu_aIrulqZFsQ 1 0 0 0 208b 208b
green open .kibana_1 kd3OSBtlSGyjKCIze8VVvQ 1 0 26 6 63kb 63kb

<span class="nv">$ </span>curl <span class="nt">-X</span> GET <span class="s2">"localhost:9200/_cat/nodes?v&amp;pretty"</span>
ip heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
172.21.0.3 20 96 5 0.85 1.52 1.08 dilmrt <span class="k">*</span> <span class="s1">'es01'</span>
</code></pre></div></div>

<p>Agora que verificamos que esta tudo está rodando normalmente vamos explorar o elasticsearch pelo kibana.</p>

<h3 id="executando-comandos-do-elasticsearch">Executando comandos do elasticsearch</h3>

<p>Vamos explorar o elasticsearch realizando operações. Com o kibana aberto vamos acessar o Console web dele para rodar as operações.</p>

<iframe width="100%" height="315" src="https://www.youtube.com/embed/jA83LpR-gmo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p>Caso você não tenha encontrado o console basta acessar a url <a href="http://0.0.0.0:5601/app/kibana#/dev_tools/console">http://0.0.0.0:5601/app/kibana#/dev_tools/console</a> ou então rodar os comandos diretamente pelo seu terminal utilizando o curl. Nestes exemplos vou disponibilizar as 2 formas. Vamos acessar a API do elasticsearch:</p>

<h4 id="api-cat----cat-indices-api">API Cat -  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-indices.html#cat-indices">cat indices API</a></h4>

<h4 id="lista-os-indices-que-temos-dispóniveis">Lista os indices que temos dispóniveis</h4>
<p>Podemos acessar os outros recursos na sessão da documentação <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cat.html">cat APIs</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># chamada no kibana</span>

GET /_cat/indices

<span class="c"># curl para rodar no terminal</span>
<span class="nv">$ </span>curl <span class="nt">-XGET</span> <span class="s2">"http://localhost:9200/_cat/indices"</span>
</code></pre></div></div>

<p>Provavelmente você deve ter tido o seguinte resultado:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>green open .kibana-event-log-7.8.0-000001 7fJFAISuQRaEqZcWLBH7oA 1 0 4 0 20.6kb 20.6kb
green open .apm-custom-link BijrW0OUQOOw7RSGJcz9HA 1 0 0 0 208b 208b
green open .kibana_task_manager_1 FvG7WnppQ6WioFlyQTF17Q 1 0 5 0 14.1kb 14.1kb
green open .apm-agent-configuration Qh9Ye6CgSMu_aIrulqZFsQ 1 0 0 0 208b 208b
green open .kibana_1 kd3OSBtlSGyjKCIze8VVvQ 1 0 38 4 77.2kb 77.2kb
</code></pre></div></div>
<p>Estes são os índices que o kibana cria. Agora vamos criar um índice e trabalhar em cima dele.</p>

<h3 id="trabalhando-com-indices">Trabalhando com indices</h3>

<h4 id="criando-um-índice-create-index-api">Criando um índice <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html">“Create index API”</a></h4>

<p>Vamos dar uma olhada em como podemos criar index.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># chamada no kibana</span>
PUT /meu_primeiro_index

<span class="c"># curl para rodar no terminal</span>
curl <span class="nt">-XPUT</span> <span class="s2">"http://localhost:9200/meu_primeiro_index"</span>
</code></pre></div></div>

<p>Dessa forma criamos um índice sem nenhum atributo. Os índices são responsáveis por armazenar os nosso documentos e nele podemos usar diversos tipos que você pode ver os suportados nessa sessão da documentação <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html">“Field datatypes”</a>. Agora vamos criar um índice com alguns campos.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># chamada no kibana</span>
PUT /filmes
<span class="o">{</span>
  <span class="s2">"mappings"</span>: <span class="o">{</span>
    <span class="s2">"properties"</span>: <span class="o">{</span>
      <span class="s2">"nome"</span>: <span class="o">{</span>
        <span class="s2">"type"</span>: <span class="s2">"text"</span>
      <span class="o">}</span>,
      <span class="s2">"descricao"</span>: <span class="o">{</span>
        <span class="s2">"type"</span>: <span class="s2">"text"</span>
      <span class="o">}</span>,
      <span class="s2">"nota"</span>: <span class="o">{</span>
        <span class="s2">"type"</span>: <span class="s2">"float"</span>
      <span class="o">}</span>,
      <span class="s2">"classificao"</span>: <span class="o">{</span>
        <span class="s2">"type"</span>: <span class="s2">"text"</span>
      <span class="o">}</span>,
      <span class="s2">"data_lancamento"</span>: <span class="o">{</span>
        <span class="s2">"type"</span>: <span class="s2">"date"</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>


<span class="c"># curl para rodar no terminal</span>
curl <span class="nt">-XPUT</span> <span class="s2">"http://localhost:9200/filmes"</span> <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-d</span><span class="s1">'{  "mappings": {    "properties": {      "nome": {        "type": "text"      },      "descricao": {        "type": "text"      },      "nota": {        "type": "float"      },      "classificao": {        "type": "text"      },      "data_lancamento": {        "type": "date"      }    }  }}'</span>
</code></pre></div></div>

<p>Após a sua criação podemos visualizar a sua estrutura da seguinte forma:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># chamada no kibana</span>
GET /filmes/_mapping
GET /filmes/_settings


<span class="c"># curl para rodar no terminal</span>
curl <span class="nt">-XGET</span> <span class="s2">"http://localhost:9200/filmes/_mapping"</span>
curl <span class="nt">-XGET</span> <span class="s2">"http://localhost:9200/filmes/_settings"</span>
</code></pre></div></div>

<ul>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html">Mapping</a> : Descreve as propriedades de um documento que vai ser inserido em um índice.</li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules.html#index-modules">Settings</a>: Descreve as configurações de um índice. Aqui são configurados um recurso muito interessante que são os <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis.html">analyzers, tokenizers, token filters and character filters.</a></li>
</ul>

<h3 id="manipulando-documentos-document-apis">Manipulando documentos <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs.html">“Document APIs”</a></h3>

<p>Nesta parte vamos entender como inserir, editar, ler e remover documentos dos indices. Vamos lá!</p>

<h4 id="criando-documentos-index-api">Criando documentos <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html">“Index API”</a>:</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># chamada no kibana</span>
POST /filmes/_doc/
<span class="o">{</span>
  <span class="s2">"nome"</span>: <span class="s2">"Matrix"</span>,
  <span class="s2">"descricao"</span>: <span class="s2">"Melhor filme ever!"</span>,
  <span class="s2">"classificao"</span>: <span class="s2">"livre"</span>,
  <span class="s2">"nota"</span>: 10,
  <span class="s2">"data_lancamento"</span>: <span class="s2">"1999-05-21T14:12:12"</span>
<span class="o">}</span>


<span class="c"># curl para rodar no terminal</span>
curl <span class="nt">-XPOST</span> <span class="s2">"http://localhost:9200/filmes/_doc/"</span> <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-d</span><span class="s1">'{  "nome": "Matrix",  "descricao": "Melhor filme ever!",  "classificao": "livre",  "nota": 10,  "data_lancamento": "1999-05-21T14:12:12"}'</span>
</code></pre></div></div>

<h4 id="editando-documentos-update-api">Editando documentos <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update.html">“Update API”</a>:</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># chamada no kibana</span>
POST filmes/_update/-DEY_XIBblRt4Ct0995B
<span class="o">{</span>
  <span class="s2">"doc"</span>: <span class="o">{</span>
    <span class="s2">"classificao"</span>: <span class="s2">"Não recomendado para menores de doze anos"</span>
  <span class="o">}</span>
<span class="o">}</span>


<span class="c"># curl para rodar no terminal</span>
curl <span class="nt">-XPOST</span> <span class="s2">"http://localhost:9200/filmes/_update/-DEY_XIBblRt4Ct0995B"</span> <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-d</span><span class="s1">'{  "doc": {    "classificao": "Não recomendado para menores de doze anos"  }}'</span>
</code></pre></div></div>

<h4 id="lendo-documentos-get-api">Lendo documentos <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-get.html">“Get API”</a>:</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># chamada no kibana</span>
GET filmes/_doc/-DEY_XIBblRt4Ct0995B

<span class="c"># curl para rodar no terminal</span>
curl <span class="nt">-XGET</span> <span class="s2">"http://localhost:9200/filmes/_doc/-DEY_XIBblRt4Ct0995B"</span>
</code></pre></div></div>

<h4 id="removendo-documentos-delete-api">Removendo documentos <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-delete.html">“Delete API”</a>:</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># chamada no kibana</span>
DELETE filmes/_doc/-DEY_XIBblRt4Ct0995B

<span class="c"># curl para rodar no terminal</span>
curl <span class="nt">-XDELETE</span> <span class="s2">"http://localhost:9200/filmes/_doc/-DEY_XIBblRt4Ct0995B"</span>
</code></pre></div></div>

<h3 id="realizando-buscas">Realizando buscas</h3>

<p>Vamos entender como fazer queries no elasticsearch. Para isso vamos continuar explorando o nosso índice recém criado de filmes. Vamos popular o mesmo com alguns filmes utilizando o <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html">“Bulk API”</a> para inserir vários documentos na mesma requisição.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /filmes/_bulk
<span class="o">{</span><span class="s2">"index"</span>:<span class="o">{}}</span>
<span class="o">{</span><span class="s2">"nome"</span>:<span class="s2">"Matrix"</span>,<span class="s2">"descricao"</span>:<span class="s2">"Melhor filme ever!"</span>,<span class="s2">"classificao"</span>:<span class="s2">"Não recomendado para menores de doze anos"</span>,<span class="s2">"nota"</span>:10,<span class="s2">"data_lancamento"</span>:<span class="s2">"1999-05-21T14:12:12"</span><span class="o">}</span>
<span class="o">{</span><span class="s2">"index"</span>:<span class="o">{}}</span>
<span class="o">{</span><span class="s2">"nome"</span>:<span class="s2">"Matrix Reloaded"</span>,<span class="s2">"descricao"</span>:<span class="s2">"Melhor filme ever!!!!"</span>,<span class="s2">"classificao"</span>:<span class="s2">"Não recomendado para menores de doze anos"</span>,<span class="s2">"nota"</span>:8.5,<span class="s2">"data_lancamento"</span>:<span class="s2">"2003-05-15T11:30:00"</span><span class="o">}</span>
<span class="o">{</span><span class="s2">"index"</span>:<span class="o">{}}</span>
<span class="o">{</span><span class="s2">"nome"</span>:<span class="s2">"Matrix Revolutions"</span>,<span class="s2">"descricao"</span>:<span class="s2">"Melhor filme ever!!!!"</span>,<span class="s2">"classificao"</span>:<span class="s2">"Não recomendado para menores de doze anos"</span>,<span class="s2">"nota"</span>:8.9,<span class="s2">"data_lancamento"</span>:<span class="s2">"2003-11-05T11:30:00"</span><span class="o">}</span>
<span class="o">{</span><span class="s2">"index"</span>:<span class="o">{}}</span>
<span class="o">{</span><span class="s2">"nome"</span>:<span class="s2">"Matrix 4"</span>,<span class="s2">"descricao"</span>:<span class="s2">"Melhor filme ever!!!!"</span>,<span class="s2">"classificao"</span>:<span class="s2">"Não recomendado para menores de doze anos"</span>,<span class="s2">"nota"</span>:0,<span class="s2">"data_lancamento"</span>:<span class="s2">"2022-04-01T11:30:00"</span><span class="o">}</span>



<span class="c"># curl para rodar no terminal</span>
curl <span class="nt">-XPOST</span> <span class="s2">"http://localhost:9200/filmes/_bulk"</span> <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-d</span><span class="s1">'{"index":{}}{"nome":"Matrix","descricao":"Melhor filme ever!","classificao":"Não recomendado para menores de doze anos","nota":10,"data_lancamento":"1999-05-21T14:12:12"}{"index":{}}{"nome":"Matrix Reloaded","descricao":"Melhor filme ever!!!!","classificao":"Não recomendado para menores de doze anos","nota":8.5,"data_lancamento":"2003-05-15T11:30:00"}{"index":{}}{"nome":"Matrix Revolutions","descricao":"Melhor filme ever!!!!","classificao":"Não recomendado para menores de doze anos","nota":8.9,"data_lancamento":"2003-11-05T11:30:00"}{"index":{}}{"nome":"Matrix 4","descricao":"Melhor filme ever!!!!","classificao":"Não recomendado para menores de doze anos","nota":0,"data_lancamento":"2022-04-01T11:30:00"}'</span>
</code></pre></div></div>

<p>Com o nosso índice populado vamos realizar algumas queries utilizando a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-search.html">“Search API”</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># chamada no kibana</span>
GET /filmes/_search

GET filmes/_search
<span class="o">{</span>
  <span class="s2">"query"</span>: <span class="o">{</span>
    <span class="s2">"match"</span>: <span class="o">{</span>
      <span class="s2">"nome"</span>: <span class="s2">"Matrix"</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

GET filmes/_search
<span class="o">{</span>
  <span class="s2">"query"</span>: <span class="o">{</span>
    <span class="s2">"match"</span>: <span class="o">{</span>
      <span class="s2">"nome"</span>: <span class="s2">"Matrix"</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>


GET /filmes/_search
<span class="o">{</span>
  <span class="s2">"query"</span>: <span class="o">{</span>
    <span class="s2">"range"</span>: <span class="o">{</span>
      <span class="s2">"nota"</span>: <span class="o">{</span>
        <span class="s2">"gte"</span>: 2,
        <span class="s2">"lte"</span>: 9
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>


<span class="c"># curl para rodar no terminal</span>
curl <span class="nt">-XGET</span> <span class="s2">"http://localhost:9200/filmes/_search"</span>

curl <span class="nt">-XGET</span> <span class="s2">"http://localhost:9200/filmes/_search"</span> <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-d</span><span class="s1">'{  "query": {    "match": {      "nome": "Matrix"    }  }}'</span>

curl <span class="nt">-XGET</span> <span class="s2">"http://localhost:9200/filmes/_search"</span> <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-d</span><span class="s1">'{  "query": {    "range": {      "nota": {        "gte": 2,        "lte": 9      }    }  }}'</span>
</code></pre></div></div>

<p>Acima utilizamos queries com o <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html">match</a> e <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html">range</a>. São queries simples mas analisando a documentação você pode incrementar esses filtros conforme a sua necessidade.</p>

<p>Se você chegou até aqui PARABÉNS!!! Você agora já sabe criar documentos e pesquisar os mesmos. Vamos seguir nosso artigo transformando agora nosso elasticsearch em cluster com mais nodes.</p>

<h3 id="criando-um-cluster-elasticsearch">Criando um cluster elasticsearch</h3>

<p>Vamos seguir utilizando o docker mas a configuração continua sendo a mesma e você basicamente precisa incluir essas propriedades no arquivo de configuração do elasticsearch que geralmente fica no /usr/share/elasticsearch/config/elasticsearch.yml ou você pode criar variáveis de ambientes seguindo o nome das chaves utilizadas. São elas:</p>

<ul>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster.name.html">cluster.name</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-settings.html#unicast.hosts">discovery.seed_hosts</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-settings.html#initial_master_nodes">cluster.initial_master_nodes</a></li>
</ul>

<p>Com isso agora vamos alterar o nosso docker-compose.yml para os seguintes valores:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2.2'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">es01</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/elasticsearch/elasticsearch:7.8.0</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">es01</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">node.name=es01</span>
      <span class="pi">-</span> <span class="s">cluster.name=es-docker-cluster</span>
      <span class="pi">-</span> <span class="s">discovery.seed_hosts=es02</span>
      <span class="pi">-</span> <span class="s">cluster.initial_master_nodes=es01</span>
      <span class="pi">-</span> <span class="s">bootstrap.memory_lock=true</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">ES_JAVA_OPTS=-Xms256m</span><span class="nv"> </span><span class="s">-Xmx256m"</span>
    <span class="na">ulimits</span><span class="pi">:</span>
      <span class="na">memlock</span><span class="pi">:</span>
        <span class="na">soft</span><span class="pi">:</span> <span class="s">-1</span>
        <span class="na">hard</span><span class="pi">:</span> <span class="s">-1</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">data01:/usr/share/elasticsearch/data</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">9200:9200</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">elastic</span>

  <span class="na">es02</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/elasticsearch/elasticsearch:7.8.0</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">es02</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">node.name=es02</span>
      <span class="pi">-</span> <span class="s">cluster.name=es-docker-cluster</span>
      <span class="pi">-</span> <span class="s">discovery.seed_hosts=es01</span>
      <span class="pi">-</span> <span class="s">cluster.initial_master_nodes=es01</span>
      <span class="pi">-</span> <span class="s">bootstrap.memory_lock=true</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">ES_JAVA_OPTS=-Xms256m</span><span class="nv"> </span><span class="s">-Xmx256m"</span>
    <span class="na">ulimits</span><span class="pi">:</span>
      <span class="na">memlock</span><span class="pi">:</span>
        <span class="na">soft</span><span class="pi">:</span> <span class="s">-1</span>
        <span class="na">hard</span><span class="pi">:</span> <span class="s">-1</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">data02:/usr/share/elasticsearch/data</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">9201:9200</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">elastic</span>

  <span class="na">kib01</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/kibana/kibana:7.8.0</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">kib01</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">5601:5601</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">XPACK_APM_SERVICEMAPENABLED</span><span class="pi">:</span> <span class="s1">'</span><span class="s">false'</span>
      <span class="na">ELASTICSEARCH_URL</span><span class="pi">:</span> <span class="s">http://es01:9200</span>
      <span class="na">ELASTICSEARCH_HOSTS</span><span class="pi">:</span> <span class="s">http://es01:9200</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">elastic</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">data01</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span>
  <span class="na">data02</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">elastic</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">bridge</span>
</code></pre></div></div>

<p>Em seguida vamos rodar o comando do docker-compose para recriar os containers:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<p>Agora precisamos aguardar os containers subirem com sucesso. Em alguns casos caso você tenha uma máquina com poucos recursos recomendo alterar a configuração no docker-compose.yml <code class="language-plaintext highlighter-rouge">ES_JAVA_OPTS=-Xms256m -Xmx256m</code> devido a problemas de recursos em sua máquina local mesmo.</p>

<p>Caso os containers estejam rodando normalmente, agora vou te mostrar abaixo a parte de monitoramento do kibana para agente acessar o nosso cluster e verificar se tudo está rodando corretamente. Vamos lá!</p>

<iframe width="100%" height="315" src="https://www.youtube.com/embed/3ljxqJ3pEcw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<h3 id="resumindo">Resumindo</h3>

<p>Neste post vimos o que é o elasticsearch e como ele funciona. Subimos um elastic local utilizando docker e docker-compose e nos conectamos ao kibana para executar as queries. Além disso também vimos como configurar um cluster localmente para testes e visualizamos no kibana a área de monitoramento em geral.</p>

<p>Nos próximos posts vamos construir um serviço de busca utilizando a linguagem de programação Go. Também iremos evoluir o nosso índice “filmes” aplicando boas práticas para um sistema de busca com o elasticsearch.</p>

<p>Grande Abraço!</p>]]></content><author><name>Raffael Tancman</name></author><category term="elasticsearch" /><summary type="html"><![CDATA[Boa parte dos sistemas tem uma ferramenta de busca e a forma como a mesma é implementada pode variar. Faz sentido utilizar o banco de dados atual da aplicação e começar a aplicar algumas features de busca, mas isso pode ser um tiro no pé quando você quer de fato entregar o melhor documento dada uma determinada busca. Nesses casos, o elasticsearch é a ferramenta que vai trazer documentos relevantes para um resultado de busca. Vamos entender nesse artigo o que é essa ferramenta e executar os principais comandos do dia a dia. No final iremos subir um cluster no docker e ver a parte de monitoramento utilizando o kibana.]]></summary></entry><entry><title type="html">De Software Engineer para Search Ranking Engineer</title><link href="https://www.rtancman.com.br/carreira/de-software-engineer-para-search-ranking-engineer.html" rel="alternate" type="text/html" title="De Software Engineer para Search Ranking Engineer" /><published>2020-06-29T20:55:00+00:00</published><updated>2020-06-29T20:55:00+00:00</updated><id>https://www.rtancman.com.br/carreira/de-software-engineer-para-search-ranking-engineer</id><content type="html" xml:base="https://www.rtancman.com.br/carreira/de-software-engineer-para-search-ranking-engineer.html"><![CDATA[<p>Sempre trabalhei como desenvolvedor fullstack e me lembro como se fosse hoje quando recebi a minha primeira oportunidade na “A Resistência”. Neste momento eu iniciava a minha jornada como profissional de tecnologia. Na maior parte das empresas em que trabalhei tive a oportunidade de trabalhar em diversas áreas sendo backend, frontend, dba e operações. Com isso, acabei adquirindo uma experiência em diversas áreas. Porém, nos últimos 4 anos passei a trabalhar como software engineer. A convite na minha atual empresa, troquei de time integrando o de busca.</p>

<p>Até então não tinha ideia de como tudo seria. Sobre busca, já havia trabalhado com uma das principais tecnologias utilizadas nas empresas que é o elasticsearch. Porém dessa vez foi bem diferente! Por onde passei, vi diversas implementações de elasticsearch. A maioria delas, utilizando o software no seu modo básico, que já é muito bom, seguindo o formato de software de prateleira e principalmente sem ter especialistas na área trabalhando junto com o time de desenvolvimento. Dessa vez seria diferente e foi aí que a mágica aconteceu!</p>

<p>Atualmente eu trabalho na Jusbrasil e por ela tive a imensa sorte de conhecer pessoas incríveis de Manaus, especificamente pesquisadores e estudantes da UFAM. Entrando nesse mundo descobri que busca vai muito além de uma simples implementação do elasticsearch existe toda uma ciência por trás que é chamada de RI ou Recuperação da Informação.</p>

<p>Falando sobre busca em si eu primeiramente imaginava ser um grande banco de dados onde rodamos um select paginado. Porém isso está longe de ser um sistema de busca e é aí que RI começa a fazer sentido. Imaginem vocês retornar milhares de resultados sem relevância para a busca que usuário está fazendo, qual seria a percepção do mesmo pelo sistema? Não é atoa que gostamos do google, porque geralmente ele traz bons resultados para os termos que buscamos e RI é a ciência por trás disso. Recomendo MUITO o <a href="https://www.youtube.com/watch?v=skDZcsOWq7U&amp;list=PLgMem-KiO8qHUcI8D7gyhqH2gv0TPzhzR">curso de RI na UFAM do prof. Dr. Edleno Silva de Moura</a> para entenderem do assunto..</p>

<h3 id="entendendo-o-que-um-sistema-de-ri-deve-fazer">Entendendo o que um sistema de RI deve fazer…</h3>

<p>Confesso a vocês que quando entrei no time me senti um extraterrestre! Eram tantos termos e algoritmos específicos que levou um tempinho para digerir todo esse novo conhecimento. Para isso contei com a ajuda dos meus amigos de time e principalmente pelo curso que comentei acima.</p>

<p>Primeiramente procurei entender do básico e o principal fato que surgiu foi Precisão X Revocação. Ou seja quando buscamos algo queremos que o documento mais relevante esteja nas primeiras posições. Isso é precisão e quanto maior os cliques nas primeiras posições temos uma boa métrica para dizer o quão preciso o nosso sistema de busca é. Entretanto, nem sempre o melhor resultado está na primeira posição e gostaríamos que os outros resultados em sequência fossem tão bons ou melhores que os primeiros. Logo quando trazemos mais documentos relevantes nos resultados de busca, estamos melhorando a revocação do nosso sistema.</p>

<p>Quando aprendi esse conceito imaginei nossa simples é trazer os documentos relevantes nas primeiras posições sempre. Mas como medimos se isso está acontecendo e que unidade de medida deveríamos utilizar?</p>

<h3 id="métricas-de-qualidade">Métricas de qualidade</h3>

<p>Falamos de Precisão X Revocação e para os resultados em geral podemos utilizar algumas métricas tais como MRR e NDCG.</p>

<p>MRR ou <a href="https://en.wikipedia.org/wiki/Mean_reciprocal_rank">Mean reciprocal rank</a>, é uma fórmula estatística para dizer o quão preciso o seu sistema de busca é. Mas como eu calculo essa informação? Precisamos registrar da lista de resultado qual é o resultado clicado e a sua posição se foi o primeiro ou último por exemplo. Tendo essa informação registrada rodamos uma fórmula para saber quão preciso o nosso sistema está.</p>

<p>NDCG ou <a href="https://en.wikipedia.org/wiki/Discounted_cumulative_gain#Normalized_DCG">Normalized Discounted cumulative gain</a> é uma métrica de normalização que é uma métrica que vai apontar a qualidade geral do seu sistema de busca. Ela leva em consideração precisão e revocação mas além disso, ela introduz a nota de documento e faz um desconto progressivo com base na sua posição.</p>

<p>Além dessas existem outras métricas e para ter um entendimento melhor recomendo a leitura do livro <a href="https://books.google.com.br/books?id=YWk3AgAAQBAJ&amp;printsec=frontcover&amp;hl=pt-BR&amp;source=gbs_ge_summary_r&amp;cad=0#v=onepage&amp;q&amp;f=false">“Recuperação de Informação: Conceitos e Tecnologia das Máquinas de Busca”</a> dos autores Berthier Ribeiro Neto e Ricardo Baeza Yates. Estou lendo este livro que é uma referência na literatura para um entendimento geral de RI e foi recomendado pelo meu time.</p>

<h3 id="como-geramos-as-métricas">Como geramos as métricas?</h3>

<p>Para isso precisamos coletar os eventos em nosso sistema de busca. Vocês devem conhecer o Google Analytics e caso você utilize essa ferramenta, pode ser uma boa usar os eventos para registrar essas informações. Muito cuidado com o Analytics porque no modo free ele exibe somente uma amostragem dos dados e isso não pode ser uma boa escolha. Agora caso você tenha acesso a todas as informações com o 360 é uma ferramenta que pode te ajudar e muito até porque com o 360 você consegue exportar todos os dados para uma tabela no bigtable por exemplo. Caso contrário a sugestão é ter de alguma forma todos as informações de busca registradas. Os eventos que precisamos registrar inicialmente são o usuário clicou no resultado da posição X e qual termo ele procurou somado com os resultados que você exibiu. Como vimos acima nas métricas, precisamos dessas informações mapeadas para criar-las e ir acompanhando as mesmas.</p>

<h3 id="search-ranking-engineer">Search Ranking Engineer</h3>

<p>Agora que vocês entenderam o que deve ser um sistema de busca e como podemos medir a sua qualidade vamos ver qual é o papel de um Ranking Engineer. Na minha concepção é um engenheiro focado em melhorar o ranking de busca utilizando algoritmos, teorias e MUITOS testes para trazer o maior número de documentos relevantes nas primeiras posições do seu sistema.</p>

<p>Essa profissão é de muito estudo, pesquisa e testes principalmente. Porque eu diria que não existe uma fórmula única e tudo depende muito do domínio da sua empresa. Além disso, cada usuário realiza a busca de uma forma peculiar em um sistema de busca e por este motivo precisamos da sua utilização e de um acompanhamento das métricas para saber se de fato alteração na forma como exibimos os resultados vem melhorando ou piorando em média.</p>

<h3 id="resumo">Resumo</h3>

<p>Esta é uma área mais científica e necessita de muita pesquisa e estudos. As tecnologias em geral são praticamente as mesmas que utilizamos como desenvolvedores em si porém os algoritmos são mais complexos e você aqui vai ver que suas aulas na faculdade de estrutura de dados vão valer cada segundo em sua vida nessa profissão.</p>

<p>Nos próximos posts vou falar sobre o elasticsearch. Vamos ver porquê e como devemos usar o mesmo para construir um sistema de busca. Falo dessa ferramenta por ser uma solução de mercado que vai ser o primeiro passo para muitas empresas melhorarem o seu sistema de busca.</p>

<p>Este post é uma introdução no assunto de RI e provavelmente na medida do possível irei continuar postando outros conteúdos relacionados sobre o que estou estudando no momento.</p>

<p><a href="/information-retrieval/elasticsearch-como-ferramenta-de-busca.html">VEJA O POST: Elasticsearch como ferramenta de busca
</a></p>

<p>Grande abraço!</p>]]></content><author><name>Raffael Tancman</name></author><category term="carreira" /><summary type="html"><![CDATA[Sempre trabalhei como desenvolvedor fullstack e me lembro como se fosse hoje quando recebi a minha primeira oportunidade na “A Resistência”. Neste momento eu iniciava a minha jornada como profissional de tecnologia. Na maior parte das empresas em que trabalhei tive a oportunidade de trabalhar em diversas áreas sendo backend, frontend, dba e operações. Com isso, acabei adquirindo uma experiência em diversas áreas. Porém, nos últimos 4 anos passei a trabalhar como software engineer. A convite na minha atual empresa, troquei de time integrando o de busca.]]></summary></entry><entry><title type="html">Quero programar, por onde começar?</title><link href="https://www.rtancman.com.br/carreira/Quero-programar-por-onde-comecar.html" rel="alternate" type="text/html" title="Quero programar, por onde começar?" /><published>2020-06-27T20:55:00+00:00</published><updated>2020-06-27T20:55:00+00:00</updated><id>https://www.rtancman.com.br/carreira/Quero-programar-por-onde-comecar</id><content type="html" xml:base="https://www.rtancman.com.br/carreira/Quero-programar-por-onde-comecar.html"><![CDATA[<p>Nesses dias um amigo veio me perguntar sobre como é ser programador e por onde começar? Como essa é uma pergunta que vejo sempre em grupos de tecnologia e em encontros da comunidade, resolvi fazer um post dando dicas de como você pode iniciar a sua carreira em tecnologia.</p>

<h3 id="a-pessoa-desenvolvedora-de-software">A pessoa desenvolvedora de software</h3>

<p>Acredito que somos profissionais do conhecimento e resolvedores de problemas. Ou seja desenvolver software e criar soluções que melhoram um processo repetitivo automatizando várias etapas. Além disso, temos casos onde soluções são criadas para facilitar o nosso dia a dia em geral como por exemplo o Uber. Dentre essas atividades existem diversas especialidades como desenvolvedor back end, front end, cientistas de dados, desenvolvimento de jogos entre outras.</p>

<p>Logo essa profissão está sempre relacionada a um contexto ou domínio e na maioria dos casos as pessoas que trabalham com tecnologia precisam entender como resolver esses problemas específicos. Vou dar um exemplo você vai fazer um software para uma escola, nesse caso precisamos entender todo o processo de trabalho que existe nessa atividade. Ou seja além de entender como uma escola funciona, você vai precisar estudar como aplicar a tributação correta para emitir boletos de mensalidades. Com isso, começamos a entender outras questões além do domínio que são necessárias para que aquele negócio funcione. Perfeito, agora vamos aprofundar na parte específica de tecnologia.</p>

<h3 id="qual-tecnologia-devo-aprender">Qual tecnologia devo aprender?</h3>

<p>Essa pergunta é muito relativa e aqui dependendo para quem você for perguntar possa ter uma resposta diferente (rs…). Procure entender de lógica de programação primeiramente e use uma tecnologia que seja fácil de se aprender. Além disso, precisa ter disciplina e montar um plano de estudos e seguir ele firme e forte!</p>

<p>A minha dica é vai de Python! Mas o que é isso? Vamos lá, Python é uma linguagem de programação. Todo software é escrito em alguma linguagem. Escolher qual linguagem aprender é difícil, e por este motivo vamos entender porque Python vai te ajudar e facilitar a sua carreira.</p>

<h3 id="porque-python">Porque Python?</h3>

<p>Simplesmente porque ela foi criada para ser utilizada por qualquer pessoa que não seja envolvida com tecnologia. Sua curva de aprendizado é baixíssima! Ou seja, ela nasceu para ser uma linguagem para os leigos, de fácil entendimento e com foco para os programadores.</p>

<p>Além disso, é uma linguagem extremamente produtiva e poderosa. Conseguimos desenvolver praticamente tudo em python! Por este motivo é uma linguagem muito bem aceita e utilizada por diversas empresas de tecnologia e na parte de ciência de dados é a linguagem mais utilizada simplesmente porque a mesma facilita as coisas. Eu fiz uma apresentação sobre esse tema e recomendo que você assista ou leia os slides <a href="https://blumenau.sc.python.org.br/encontros/2019/08/22/python-nas-empresas-edicao-hbsis.html">clicando aqui</a>.</p>

<p>Python tem uma comunidade ao redor que é INCRÍVEL e não mede esforços para ajudar as pessoas a entrarem no mundo de tecnologia. Sim, além de ser fácil de aprender temos um grupo muito forte que vai te ajudar!</p>

<h3 id="aprendendo-python">Aprendendo Python</h3>

<p>Essa dica é de ouro e não se aplica somente a essa tecnologia. Atualmente temos diversos conteúdos gratuitos na internet para você começar a estudar de casa mesmo. Vou listar abaixo os que eu acredito serem os melhores cursos para você iniciar a sua carreira:</p>

<ul>
  <li>Python para Zumbis - Fernando Masanori Professor FATEC-SP
    <ul>
      <li><a href="https://www.pycursos.com/python-para-zumbis/">https://www.pycursos.com/python-para-zumbis/</a></li>
      <li><a href="https://www.youtube.com/channel/UCripRddD4BnaMcU833ExuwA">https://www.youtube.com/channel/UCripRddD4BnaMcU833ExuwA</a></li>
    </ul>
  </li>
  <li>Curso de Python 3 - Gustavo Guanabara
    <ul>
      <li><a href="https://www.cursoemvideo.com/course/curso-python-3/">https://www.cursoemvideo.com/course/curso-python-3/</a></li>
    </ul>
  </li>
  <li>Python for Absolute Beginners Green Chameleon Learning
    <ul>
      <li><a href="https://www.udemy.com/python-for-absolute-beginners-u/">https://www.udemy.com/python-for-absolute-beginners-u/</a></li>
    </ul>
  </li>
  <li>Ciência da Computação com Python - USP
    <ul>
      <li><a href="https://www.coursera.org/learn/ciencia-computacao-python-conceitos">https://www.coursera.org/learn/ciencia-computacao-python-conceitos</a></li>
    </ul>
  </li>
  <li>Google’s Python Class
    <ul>
      <li><a href="https://developers.google.com/edu/python/">https://developers.google.com/edu/python/</a></li>
    </ul>
  </li>
  <li>Curso Python 300 - Marcos Castro
    <ul>
      <li><a href="https://www.youtube.com/playlist?list=PL8eBmR3QtPL0j3QLEjQ6rcx8rVB8Ir893">https://www.youtube.com/playlist?list=PL8eBmR3QtPL0j3QLEjQ6rcx8rVB8Ir893</a></li>
    </ul>
  </li>
</ul>

<p>Eu recomendo e MUITO Python para Zumbis para quem está começando a programar. A didática do curso é fantástica. Ler a documentação de cada tecnologia que você vai utilizar no dia a dia também é importante e será um guia para tirar as suas dúvidas.</p>

<p>Outra recomendação é conheca as pessoas que trabalham com desenvolvimento de software. E falando especificamente de Python, temos a comunidade como porta de entrada. Praticamente em todos os lugares do Brasil e do mundo, temos uma comunidade ativa realizando encontros recorrentes. <a href="https://python.org.br/comunidades-locais/">Neste link</a> da Associação Python Brasil conseguimos encontrar a maioria das comunidades locais. Caso você não encontre alguma na sua cidade entre em contato comigo pelo meu site mesmo que eu vou te ajudar a conectar as pessoas próximas a você.</p>

<h3 id="fiz-o-curso-e-aê-como-começo-a-trabalhar">Fiz o curso e aê? Como começo a trabalhar?</h3>

<p>Nos dias de hoje devido a escassez de pessoas que desenvolvem software no mercado muitas das empresas tem investido em treinamentos gratuitos para quem quer aprender a programar. Ou seja, você participa de um curso e na conclusão do mesmo você pode ser contratado por uma empresa de tecnologia. Vou listar alguns desses programas que eu recomendo para você ficar de olho que são estes aqui:</p>

<ul>
  <li><a href="https://hbsis.com.br/padawan/">PADAWAN - HBSIS</a></li>
  <li><a href="http://codenation.dev">Codenation</a></li>
</ul>

<p>Esses programas abrem uma seleção pela internet e em seguida caso você seja escolhido o treinamento é iniciado. Nesse caso depende muito do contexto da empresa e com isso as tecnologias que você vai aprender vão ser definidas pela mesma. Mas acredito ser uma porta de entrada interessante para iniciar a sua carreira.</p>

<p>Também recomendo participar de processos seletivos ou programas de estágios e seguindo essa linha eu tenho esses a recomendar:</p>

<ul>
  <li><a href="https://estag.globo.com/#/voce-nasceu-pra-isso">Programa de estágio na Globo.com</a></li>
  <li><a href="https://estagio.b2w.io/">Programa de estágio na B2W</a></li>
</ul>

<h3 id="resumindo">Resumindo…</h3>

<p>A jornada para ser uma pessoa desenvolvedora de software nem sempre vai ser fácil apesar de todo o cenário favorecedor. Mas é um caminho que pode sim ser muito gratificante para o seu futuro. Não desista dos seus sonhos e conte comigo e com a comunidade para te ajudar neste relacionado a tecnologia!</p>

<p>Grande abraço!</p>]]></content><author><name>Raffael Tancman</name></author><category term="carreira" /><summary type="html"><![CDATA[Nesses dias um amigo veio me perguntar sobre como é ser programador e por onde começar? Como essa é uma pergunta que vejo sempre em grupos de tecnologia e em encontros da comunidade, resolvi fazer um post dando dicas de como você pode iniciar a sua carreira em tecnologia.]]></summary></entry><entry><title type="html">Kubernetes para iniciantes</title><link href="https://www.rtancman.com.br/kubernetes/kubernetes-para-iniciantes.html" rel="alternate" type="text/html" title="Kubernetes para iniciantes" /><published>2020-06-15T20:55:00+00:00</published><updated>2020-06-15T20:55:00+00:00</updated><id>https://www.rtancman.com.br/kubernetes/kubernetes-para-iniciantes</id><content type="html" xml:base="https://www.rtancman.com.br/kubernetes/kubernetes-para-iniciantes.html"><![CDATA[<p>Me lembro como se fosse hoje quando comecei a virtualizar o meu ambiente de desenvolvimento. Antes rodava tudo em uma VM do VirtualBox montando o diretório do meu projeto na VM. Com o passar dos tempos acabei conhecendo o <a href="https://www.vagrantup.com/">Vagrant</a> e mais a frente o <a href="https://www.docker.com/">Docker</a> que foi amor à primeira vista! Desde então passei a gerenciar meu ambiente de desenvolvimento com docker-compose.</p>

<p>Participei de um movimento de migrar aplicações que rodam no heroku para o Google Cloud utilizando o serviço Kubernetes Engine o GKE. Nesse projeto eu trabalhei bem superficialmente com k8s, apelido do kubernetes. Atualmente venho trabalhando diariamente com essa ferramenta e neste artigo vou contar como foi todo o meu aprendizado e sintetizar os principais casos do dia a dia.</p>

<h3 id="o-que-é-o-kubernetes">O que é o Kubernetes?</h3>

<p>É um gerenciador de containers onde utilizamos uma sintaxe declarativa para criar nossos serviços na cloud. O kubernetes veio nessa era de containers para facilitar todas as operações e boas práticas que temos hoje disponíveis em cloud para deployar suas aplicações. Com isso foi sendo construído um ecossistema em volta dessa tecnologia com muitos serviços e plugins tais como recursos de monitoração, autoscale, blue-green deployments, service discovery e muitos outros disponíveis pela comunidade.</p>

<h3 id="como-ele-funciona">Como ele funciona?</h3>

<p><img alt="k8s arquitetura" src="/img/posts/2020/06/k8s-arquitetura.png" style="max-width: 992px;width: 100%;" />
Fonte: kubernetes.io</p>

<p>De forma resumidamente o k8s é uma aplicação em Go que se comunica através de uma API. O Docker não consegue gerenciar containers de maneira remota e é aí que o k8s passa a fazer sentido. Essa arquitetura acima foi retirada do site oficial do kubernetes e pode ser acessada <a href="https://kubernetes.io/docs/concepts/overview/components/">aqui</a> onde temos a documentação que detalha esse processo por inteiro. Mas para vocês entenderem de uma forma geral, temos 2 nodes onde em 1 temos rodando a API do k8s com todo os seus componentes como etcd que é o banco de chave valor onde ficam salvas todas as configurações e no segundo node temos o kubelet que é o cliente responsável em se comunicar com a API do k8s e aplicar as alterações nos containers que rodam em cada máquina.</p>

<p>O objetivo desse artigo é ser um guia prático de como você pode executar os serviços em ambiente local ou até mesmo em cloud, não vou entrar em detalhes de como funciona todos os componentes do kubernetes. Para isso você pode e deve ler a documentação para entender como essa ferramenta irá te ajudar no dia a dia. <a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/">Neste link você confere a documentação do Kubernetes que é bem completa e repleta de exemplos.</a></p>

<p>Agora precisamos instalar o nosso ambiente de trabalho que basicamente vai precisar do Docker, Kubernetes e algumas outras aplicações para deployar o nosso sistema.</p>

<h3 id="instalação">Instalação:</h3>

<p>Vamos precisar instalar o <a href="http://kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a> e o <a href="http://github.com/kubernetes/minikube#installation">minikube</a> para quem tem linux. No  mac, o próprio docker já tem um suporte para subir um cluster k8s. Caso você esteja rodando no mac, segue um tutorial de como levantar um cluster local <a href="https://xebia.com/blog/running-kubernetes-locally-docker-mac-os-x/">nesse link aqui</a>.</p>

<ul>
  <li>Kubectl: É o CLI para iteragir com o cluster k8s.</li>
  <li>Minikube: Simula em uma VM o funcionamento de um cluster k8s em ambiente local.</li>
</ul>

<p>Para você já sair executando os comandos do kubectl recomendo esses playgrounds:</p>
<ul>
  <li><a href="https://www.katacoda.com/courses/kubernetes/playground">Katacoda</a></li>
  <li><a href="https://labs.play-with-k8s.com/">Play with Kubernetes</a></li>
</ul>

<p>Agora que já temos um um cluster rodando, vamos iniciar dar uma explorada nos principais comandos do k8s que vamos utilizar durante o desenvolvimento.</p>

<p>O k8s permite que você gerencie diversos clusters e por isso e sempre bom ver os que estão configurados com o comando <code class="language-plaintext highlighter-rouge">kubectl config get-contexts</code>. Exemplo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl config get-contexts
CURRENT NAME CLUSTER AUTHINFO NAMESPACE

docker-desktop docker-desktop docker-desktop

<span class="k">*</span> docker-for-desktop docker-desktop docker-desktop
</code></pre></div></div>

<p>Para selecionar um contexto você roda o seguinte comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl config use-context docker-for-desktop
</code></pre></div></div>

<p>Esses passos são importantes principalmente se você já tem acesso a um cluster k8s na sua máquina para não criar nada em cluster que já exista ;)</p>

<h3 id="k8s-em-prática-com-um-pod-simples">K8S em prática com um pod simples</h3>

<p>Vamos subir agora um Pod com o Wordpress baseado em uma imagem do Docker que está disponível no <a href="https://hub.docker.com/_/wordpress/">hub docker do wordpress</a> para testar alguns dos comandos do k8s. Não se preocupe com o arquivo abaixo vamos entender ele melhor mais a frente ;)</p>

<p>Crie o arquivo wp-dumb.yaml com o seguinte conteudo abaixo:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">wordpress</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-wp-1</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">wordpress:php7.2-fpm</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">9000</span>
</code></pre></div></div>

<p>Agora vamos subir o nosso primeiro Pod! Para isso vamos rodar o seguinte comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> wp-dumb.yaml
</code></pre></div></div>

<p>Acima vimos o nosso primeiro comando o kubectl apply como vocês já viram, ele é responsável em aplicar alterações feita no arquivo wp-dumb.yaml. Após ele aplicar essa alteração o k8s se encarrega em subir um Pod com a configuração descrita no manifesto do aquivo wp-dumb.yaml. Agora podemos rodar outros comandos para visualizar como esta este Pod recem criado.</p>

<p>Para listar todos os pods rodando vamos executar o <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#get">kubectl get</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get pods

<span class="c">#resultado</span>

NAME READY STATUS RESTARTS AGE

meu-blog 1/1 Running 0 59s
</code></pre></div></div>

<p>O comando get diz como está o nosso Pod em nosso cluster. Veja em detalhes:</p>

<ul>
  <li>NAME: é o nome do Pod. E este nome é ÚNICO.</li>
  <li>READY: diz que o nosso Pod está rodando / pronto.</li>
  <li>STATUS: é o status atual de execução</li>
  <li>RESTARTS: quantidade de restarts que o pod teve</li>
  <li>AGE: A quanto tempo ele foi criado</li>
</ul>

<p><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#get">Aqui na documentação do k8s</a> você tem todos os exemplos dos comandos a serem executados. Mas vamos falar dos que mais rodamos no dia a dia.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># para buscar um pod por nome</span>
<span class="nv">$ </span>kubectl get pods meu-blog

<span class="c"># para buscar um pod por label</span>
<span class="nv">$ </span>kubectl get pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>wordpress

<span class="c"># para retornar em outro formato de output</span>
<span class="nv">$ </span>kubectl get pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>wordpress <span class="nt">-o</span> yaml
<span class="nv">$ </span>kubectl get pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>wordpress <span class="nt">-o</span> json
</code></pre></div></div>

<p>Também podemos acessar esse Pod rodando o <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#exec">kubectl exec</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> meu-blog bash
root@meu-blog:/var/www/html#
</code></pre></div></div>

<p>Descrição desse Pod rodando o <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#describe">kubectl describe</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl describe pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>wordpress
<span class="nv">$ </span>kubectl describe pods meu-blog
</code></pre></div></div>

<p>Copiando arquivos para o container ou do container para a sua máquina com o comando cp rodando o <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#cp">kubectl cp</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># criando um arquivo qualquer</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"lala"</span> <span class="o">&gt;</span> arquivo-lala.txt

<span class="c"># copiando um arquivo para o container</span>
<span class="nv">$ </span>kubectl <span class="nb">cp </span>arquivo-lala.txt meu-blog:/var/www/html

<span class="c"># copiando um arquivo do container para sua maquina</span>
<span class="nv">$ </span>kubectl <span class="nb">cp </span>meu-blog:/var/www/html/arquivo-lala.txt arquivo-lele.txt
</code></pre></div></div>

<p>Verificando CPU e Memoria com o comando top rodando o <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#top">kubectl top</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl top pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>wordpress
<span class="nv">$ </span>kubectl top pods meu-blog
</code></pre></div></div>

<p>Remover um Pod rodando o <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#delete">kubectl delete</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>wordpress
<span class="nv">$ </span>kubectl delete pods meu-blog
</code></pre></div></div>

<p>Se você chegou até aqui MEUS PARABÉNS você conseguiu subir um pod e principalmente executar uns dos comandos que mais utilizamos no dia a dia! Na documentação oficial, temos uma parte muito interessante com os “macetes” para servir como um guia quando você não se lembrar exatamente como é cada comando do k8s que é o <a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/">kubectl Cheat Sheet</a>.</p>

<h3 id="k8s-em-prática-subindo-um-wordpress-completo">K8S em prática subindo um wordpress completo</h3>

<p>Nosso aplicação que irá rodar no kubernetes vai ser um wordpress um dos principais cms do mundo. Teremos a seguinte arquitetura:</p>

<p><img alt="wordpress no k8s arquitetura" src="/img/posts/2020/06/wp-k8s.jpg" style="max-width: 992px;width: 100%;" /></p>

<p>No exemplo anterior a gente utilizou o objeto Pod que é o objeto mais genérico do k8s. <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Aqui na documentação você tem todos os detalhes</a>. Agora nesse exemplo vamos utilizar o <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployment</a> para criar um Pod mais inteligente dizendo em seu manifesto a quantidade de réplicas que devem sempre executar em nosso cluster. Isso mesmo, o k8s com base no manifesto vai gerenciar a execução desse pod podendo remover e recriar o mesmo caso alguma coisa de errado aconteça. Vamos a esse manifesto:</p>

<p>Crie o arquivo wp-deployment.yaml com o seguinte conteúdo abaixo:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">wordpress-escalavel</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">wordpress-escalavel</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">wordpress-escalavel</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">wordpress:5.4.2-php7.2-apache</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<p>Agora vamos subir o nosso primeiro deployment!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> wp-deployment.yaml
</code></pre></div></div>

<p>Sim temos 3 pods em execução vamos olhar rodando o comando get:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>wordpress-escalavel
NAME READY STATUS RESTARTS AGE
meu-blog-escalavel-69f498dc5b-25zb7 1/1 Running 0 19s
meu-blog-escalavel-69f498dc5b-7dx4z 1/1 Running 0 19s
meu-blog-escalavel-69f498dc5b-zbtvs 1/1 Running 0 19s
</code></pre></div></div>

<p>Agora vamos brincar com o k8s vamos deletar o um dos Pods criados e ficar dando o get para ver o que esta irá acontecer.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete pod meu-blog-escalavel-69f498dc5b-c7hvd
pod <span class="s2">"meu-blog-escalavel-69f498dc5b-c7hvd"</span> deleted

<span class="nv">$ </span>kubectl get pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>wordpress-escalavel
NAME READY STATUS RESTARTS AGE
meu-blog-escalavel-69f498dc5b-7dx4z 1/1 Running 0 4m33s
meu-blog-escalavel-69f498dc5b-c7hvd 0/1 Terminating 0 36s
meu-blog-escalavel-69f498dc5b-jb424 1/1 Running 0 6s
meu-blog-escalavel-69f498dc5b-zbtvs 1/1 Running 0 4m33s
</code></pre></div></div>

<p>Caso algum pode seja deletado o k8s sobe outro o mais rápido possível e mantém sempre o que está configurado no manifesto do arquivo wp-deployment.yaml. Agora vamos explorar novos comandos que os deployments tem que é o <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#scale">kubectl scale</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl scale deployment meu-blog-escalavel <span class="nt">--replicas</span><span class="o">=</span>5

<span class="nv">$ </span>kubectl get pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>wordpress-escalavel

NAME READY STATUS RESTARTS AGE
meu-blog-escalavel-69f498dc5b-66bbr 1/1 Running 0 7s
meu-blog-escalavel-69f498dc5b-7dx4z 1/1 Running 0 22h
meu-blog-escalavel-69f498dc5b-jb424 1/1 Running 0 22h
meu-blog-escalavel-69f498dc5b-x57f8 1/1 Running 0 7s
meu-blog-escalavel-69f498dc5b-zbtvs 1/1 Running 0 22h
</code></pre></div></div>

<p>Pronto nosso sistema do wordpress está escalável podendo subir ou diminuir réplicas. Agora falta a gente configurar o nosso load balancer, que no caso do k8s será o <a href="https://kubernetes.io/docs/concepts/services-networking/service/">Service</a>. Este é responsável em localizar o nosso deployment e expor o serviço do mesmo através de um endereço tendo o funcionamento comparado ao de um load balancer distribuindo a carga. Vamos a esse manifesto:</p>

<p>Crie o arquivo wp-service.yaml com o seguinte conteúdo abaixo:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel-service</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">wordpress-escalavel</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<p>Agora vamos subir o nosso primeiro service!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> wp-service.yaml
</code></pre></div></div>

<p>Para visualizar o nosso service executando rodamos o comando get mas agora incluindo o tipo service. Sim o k8s segue um padrão e trocando o kind você lista somente os pods de um tipo específico.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get service

NAME TYPE CLUSTER-IP EXTERNAL-IP PORT<span class="o">(</span>S<span class="o">)</span> AGE
meu-blog-escalavel-service ClusterIP 10.102.166.220 localhost 8080/TCP 7m57s
</code></pre></div></div>

<p>Agora todos os nossos deployments ficam acessíveis através do service recém criado que consegue localizar os pods por conta da configuração de selector que utiliza o label aplicado a um pod para localizar para onde a requisição deve chegar. Agora basta chamar localhost:8080 que vamos bater no service e o mesmo redireciona o tráfego para os nossos deployments como um load balancer. Agora que já temos o nosso LB e wordpress de pé precisamos subir o nosso banco de dados. Vamos a esse manifesto:</p>

<p>Crie o arquivo wp-mariadb.yaml com o seguinte conteúdo abaixo:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">Recreate</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">rtancman/mariadb-local</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Always"</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">adminroot</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_USER</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">wp-user</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_PASSWORD</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">q1w2e3r4</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_DATABASE</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">wp-k8s</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">3306</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
</code></pre></div></div>

<p>Com isso agora como já sabemos, falta criar o nosso service e vamos lá! Crie o arquivo wp-mariadb-service.yaml com o seguinte conteúdo abaixo:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mariadb-service</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mariadb-wp</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">3306</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">3306</span>
</code></pre></div></div>

<p>Agora vamos dar apply em todos os manifestos recém criados:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">$ kubectl apply -f wp-mariadb.yaml</span>
<span class="s">$ kubectl apply -f wp-mariadb-service.yaml</span>
</code></pre></div></div>
<p>Agora temos o nosso banco rodando! Com isso vamos alterar o nosso manifesto do wp-deployment.yaml para incluir as variáveis de ambiente que tem o acesso ao banco de dados.</p>

<p>Altere o arquivo wp-deployment.yaml com o seguinte conteúdo abaixo:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">meu-blog-escalavel</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">wordpress-escalavel</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">wordpress-escalavel</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">wordpress-escalavel</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">wordpress</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">wordpress:5.4.2-php7.2-apache</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_HOST</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">mariadb-service</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_USER</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">wp-user</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_PASSWORD</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">q1w2e3r4</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">WORDPRESS_DB_NAME</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">wp-k8s</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<p>MEUS PARABÉNS! Você acabou de configurar a nossa arquitetura proposta no exemplo e tudo esta deve estar rodando normalmente se você acessar o <a href="http://localhost:8080/">http://localhost:8080/</a> deve cair na página de configuração do wordpress e seguindo os passos você terá o mesmo rodando no seu cluster k8s \o/.</p>

<p>Kubernetes é uma ferramenta com muitos plugins e serviços e irei fazer um novo post melhorando essa nossa arquitetura utilizando outros objetos do k8s como o <a href="https://kubernetes.io/docs/concepts/configuration/secret/">Secrets</a>, <a href="https://kubernetes.io/docs/concepts/configuration/configmap/">Configmap</a>, <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistent-volumes">PersistentVolume</a> e <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">PersistentVolumeClaim</a>.</p>

<p>Referências:</p>
<ul>
  <li><a href="https://kubernetes.io/docs/concepts/">https://kubernetes.io/docs/concepts/</a></li>
  <li><a href="https://kubernetes.io/docs/tutorials/stateful-application/mysql-wordpress-persistent-volume/">https://kubernetes.io/docs/tutorials/stateful-application/mysql-wordpress-persistent-volume/</a></li>
  <li><a href="https://xebia.com/blog/running-kubernetes-locally-docker-mac-os-x/">https://xebia.com/blog/running-kubernetes-locally-docker-mac-os-x/</a></li>
  <li><a href="https://medium.com/containers-101/local-kubernetes-for-mac-minikube-vs-docker-desktop-f2789b3cad3a">https://medium.com/containers-101/local-kubernetes-for-mac-minikube-vs-docker-desktop-f2789b3cad3a</a></li>
</ul>

<p>Grande abraço xD</p>]]></content><author><name>Raffael Tancman</name></author><category term="kubernetes" /><summary type="html"><![CDATA[Me lembro como se fosse hoje quando comecei a virtualizar o meu ambiente de desenvolvimento. Antes rodava tudo em uma VM do VirtualBox montando o diretório do meu projeto na VM. Com o passar dos tempos acabei conhecendo o Vagrant e mais a frente o Docker que foi amor à primeira vista! Desde então passei a gerenciar meu ambiente de desenvolvimento com docker-compose.]]></summary></entry><entry><title type="html">Criando um sistema de notificações com pywebpush</title><link href="https://www.rtancman.com.br/python/criando-sistema-de-notificacoes-com-pywebpush.html" rel="alternate" type="text/html" title="Criando um sistema de notificações com pywebpush" /><published>2019-03-30T20:55:00+00:00</published><updated>2019-03-30T20:55:00+00:00</updated><id>https://www.rtancman.com.br/python/criando-sistema-de-notificacoes-com-pywebpush</id><content type="html" xml:base="https://www.rtancman.com.br/python/criando-sistema-de-notificacoes-com-pywebpush.html"><![CDATA[<p>Esses dias um amigo veio me perguntar no GruPy Blumenau em como criar um sistema de notificações e acabei passando meio que o caminho das pedras que poderia utilizar o <a href="https://firebase.google.com/">Firebase</a> ou utilizar o <a href="https://developer.mozilla.org/en-US/docs/Web/API/notification">notification API</a> para isso. Como eu nunca tinha desenvolvido um sistema para esse caso resolvi então criar um post sobre este tema.</p>

<h2 id="web-push-notifications">Web Push Notifications</h2>

<p>Existe um padrão para realizar esse tipo de operação na web que é o <a href="https://developer.mozilla.org/en-US/docs/Web/API/Push_API">Push API</a>.</p>

<p><img src="/img/posts/2019/03/Push_API.jpg" alt="Push API" /></p>

<p>Basicamente o que acontece é o seguinte:</p>

<ol>
  <li>O cliente solicita permissão ao navegador para receber notificações</li>
  <li>O navegador gera uma credencial de acesso e o cliente passa esses dados para o servidor</li>
  <li>O servidor manda uma notificação com as credenciais para o serviço</li>
  <li>O serviço notifica os navegadores</li>
</ol>

<p>Todo este processo utiliza o <a href="https://tools.ietf.org/html/draft-ietf-webpush-protocol-12">Web Push Protocol</a>. Este protocolo descreve como toda essa comunicação deve ser feita e com isso temos um padrão para enviar notificações para os navegadores. O projeto <a href="https://github.com/web-push-libs">web-push-libs</a> tem implementações desse protocolo para diversas linguagens. Neste post vamos utilizar a implementação feita para Python que é o <a href="https://github.com/web-push-libs/pywebpush">pywebpush</a>.</p>

<h2 id="sistema-de-notifição">Sistema de Notifição</h2>

<p>Vamos criar uma API e um site. Todo o código esta disponível no repositorio <a href="https://github.com/rtancman/flask-pywebpush">flask-pywebpush</a>. Além disso apaixonado por Makefile como sou criei todos os comandos que iremos executar nele para saber mais acesse o <a href="https://github.com/rtancman/flask-pywebpush/blob/master/Makefile">arquivo e veja os comandos na íntegra</a>.</p>

<h3 id="api-de-notificação">API de notificação</h3>
<p>Na nossa API vamos utilizar flask, redis e pywebpush para desenvolver nossa aplicação.</p>

<p>A API armazenará as informações de assinatura dos usuários e distribuirá a chave pública VAPID. VAPID é o curto prazo para Identificação Voluntária do Servidor de Aplicativos, a chave pública gerada será usada através do aplicativo cliente.</p>

<p>Gerando as chaves:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
make generate.vapid

</code></pre></div></div>
<p>OBS: Estou usando como base <strong>linux</strong> e o <strong>openssl</strong>. Portanto para gerar essas chaves você precisa ter o openssl instalado em sua máquina.</p>

<p>Após rodar o comando vamos ter gerado os seguintes arquivos no diretório <strong>flaskwebpush/certs</strong> no projeto:</p>

<ul>
  <li>private_key.txt</li>
  <li>public_key.txt</li>
  <li>vapid_private.pem</li>
  <li>vapid_public.pem</li>
</ul>

<p>Nosso backend terá as seguintes rotas:</p>

<ul>
  <li>/api/subscribe</li>
  <li>/api/notify</li>
  <li>/api/unsubscribe</li>
</ul>

<h3 id="apisubscribe">/api/subscribe</h3>

<p>Responsável por inscrever o cliente para receber notificações do nosso site. Esta rota atende aos verbos:</p>

<p>GET - Responsável por retornar a chave pública a ser utilizada no cliente que é o nosso site
POST - Responsável por inscrever o cliente. Aqui recebemos o endereço e as credenciais de acesso para realizar o push de notificação.</p>

<p>Segue o código:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">@</span><span class="n">api</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/subscribe'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">subscribe</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">"GET"</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'public_key'</span><span class="p">:</span> <span class="n">VAPID_PUBLIC_KEY</span><span class="p">})</span>
    <span class="k">print</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">)</span>
    <span class="n">subscription_info</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">'endpoint'</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'endpoint'</span><span class="p">),</span>
      <span class="s">'keys'</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'keys'</span><span class="p">),</span>
      <span class="s">'expiration_time'</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'expirationTime'</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">webpush_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">redis_webpush</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">'webpush:subscription:info:{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">webpush_key</span><span class="p">),</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">subscription_info</span><span class="p">))</span>
    <span class="n">redis_webpush</span><span class="p">.</span><span class="n">sadd</span><span class="p">(</span><span class="s">'webpush:subscriptions'</span><span class="p">,</span> <span class="n">webpush_key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'id'</span><span class="p">:</span> <span class="n">webpush_key</span><span class="p">})</span>

</code></pre></div></div>

<h3 id="apinotify">/api/notify</h3>

<p>Responsável em realizar o push dessa notificação aos clientes inscritos no nosso site. Esta recebe um POST com os dados da mensagem que queremos enviar aos clientes. Segue o código:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">@</span><span class="n">api</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/notify'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">notify</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">pywebpush</span> <span class="kn">import</span> <span class="n">webpush</span><span class="p">,</span> <span class="n">WebPushException</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sub_webpush_key</span> <span class="o">=</span> <span class="s">'webpush:subscription:info:{}'</span>
    <span class="n">message_data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">'title'</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'title'</span><span class="p">),</span>
      <span class="s">'body'</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'body'</span><span class="p">),</span>
      <span class="s">'url'</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'url'</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">redis_webpush</span><span class="p">.</span><span class="n">smembers</span><span class="p">(</span><span class="s">'webpush:subscriptions'</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sub_key</span> <span class="o">=</span> <span class="n">sub_webpush_key</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">decode</span><span class="p">())</span>
            <span class="n">sub_val</span> <span class="o">=</span> <span class="n">redis_webpush</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">sub_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sub_val</span><span class="p">:</span>
              <span class="n">webpush</span><span class="p">(</span>
                  <span class="n">subscription_info</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">sub_val</span><span class="p">),</span>
                  <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message_data</span><span class="p">),</span>
                  <span class="n">vapid_private_key</span><span class="o">=</span><span class="n">VAPID_PRIVATE_KEY</span><span class="p">,</span>
                  <span class="n">vapid_claims</span><span class="o">=</span><span class="n">VAPID_CLAIMS</span>
              <span class="p">)</span>
              <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="n">WebPushException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"{} notification(s) sent"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

</code></pre></div></div>

<h3 id="apiunsubscribe">/api/unsubscribe</h3>

<p>Responsável por descadastrar o cliente que não quer mais receber notificações do nosso site. Recebe um POST com o identificador do cliente para remover. Segue o código:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">@</span><span class="n">api</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/unsubscribe'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">unsubscribe</span><span class="p">():</span>
    <span class="n">webpush_key</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'client_uuid'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">webpush_key</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'message'</span><span class="p">:</span> <span class="s">'client_uuid is required'</span><span class="p">}),</span> <span class="mi">400</span>
             <span class="n">redis_webpush</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="s">'webpush:subscription:info:{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">webpush_key</span><span class="p">))</span>
    <span class="n">redis_webpush</span><span class="p">.</span><span class="n">srem</span><span class="p">(</span><span class="s">'webpush:subscriptions'</span><span class="p">,</span> <span class="n">webpush_key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'message'</span><span class="p">:</span> <span class="s">'unsubscribed'</span><span class="p">})</span>

</code></pre></div></div>

<p>Agora que conhecemos a nossa API vamos rodar o nosso projeto:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
git clone git@github.com:rtancman/flask-pywebpush.git

<span class="nb">cd </span>flask-pywebpush

python3 <span class="nt">-m</span> venv .venv

make setup setup.web

<span class="c"># levando o redis com docker</span>
make run.redis

<span class="c"># rodando a api</span>
make run.api

<span class="c"># rodando o site web</span>
run.web

</code></pre></div></div>

<p>Com a nossa aplicação rodando, abra no seu navegador o endereço <a href="http://127.0.0.1:8080">http://127.0.0.1:8080</a>. Neste link temos o nosso site que foi baseado no projeto <a href="https://github.com/GoogleChromeLabs/web-push-codelab">GoogleChromeLabs/web-push-codelab</a>.</p>

<p>Vamos realizar a ação para se inscrever:</p>

<p><img src="/img/posts/2019/03/notificacoes-clicar-para-receber.gif" alt="Clicando para receber notificações" /></p>

<p>Após clicar no button, vamos ver as credenciais de acesso que são enviadas ao nosso servidor. Após este processo, agora vamos enviar a nossa mensagem pelo servidor e para isso vamos utilizar o curl para fazer o post:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
curl <span class="nt">-X</span> POST <span class="se">\</span>
  http://127.0.0.1:5000/api/notify <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'cache-control: no-cache'</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
	"title": "Minha notificação!",
	"url": "http://localhost:8080/",
	"body": "O corpo da minha notificação com a menssagem."
}'</span>

</code></pre></div></div>

<p>Após realizar este comando você irá receber uma notificação como abaixo:</p>

<p><img src="/img/posts/2019/03/notificacoes-recebendo-notificacao.gif" alt="Recebendo notificações" /></p>

<p>Com isso fechamos por aqui nosso sistema simples de notificação. Para testar a API diretamente do postman basta importar o arquivo <a href="https://github.com/rtancman/flask-pywebpush/flaskwebpush.postman_collection.json">flaskwebpush.postman_collection.json</a>.</p>

<p>Para se aprofundar mais no assunto recomendo a leitura desses links:</p>

<ul>
  <li><a href="https://developers.google.com/web/fundamentals/push-notifications/">https://developers.google.com/web/fundamentals/push-notifications/</a></li>
  <li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Push_API">https://developer.mozilla.org/en-US/docs/Web/API/Push_API</a></li>
  <li><a href="https://serviceworke.rs/web-push.html">https://serviceworke.rs/web-push.html</a></li>
</ul>

<p>Grande abraço!</p>]]></content><author><name>Raffael Tancman</name></author><category term="python" /><summary type="html"><![CDATA[Esses dias um amigo veio me perguntar no GruPy Blumenau em como criar um sistema de notificações e acabei passando meio que o caminho das pedras que poderia utilizar o Firebase ou utilizar o notification API para isso. Como eu nunca tinha desenvolvido um sistema para esse caso resolvi então criar um post sobre este tema.]]></summary></entry><entry><title type="html">Organizando AWS Lambda escrito em Python</title><link href="https://www.rtancman.com.br/python/aws/organizando-aws-lambda-escrito-python.html" rel="alternate" type="text/html" title="Organizando AWS Lambda escrito em Python" /><published>2019-01-11T22:55:00+00:00</published><updated>2019-01-11T22:55:00+00:00</updated><id>https://www.rtancman.com.br/python/aws/organizando-aws-lambda-escrito-python</id><content type="html" xml:base="https://www.rtancman.com.br/python/aws/organizando-aws-lambda-escrito-python.html"><![CDATA[<p>Continuando a série de posts relacionados ao AWS Lambda. Caso você tenha lido o primeiro post ou não conheça este serviço da Amazon, recomendo a leitura do artigo <a href="/python/aws/aws-lambda-e-python.html">AWS Lambda + Python - Como criar o setup de um projeto Python para rodar no AWS Lambda.</a></p>

<p>No meu primeiro contato com o lambda não procurei nenhum framework para organizar o trabalho e apaixonado por <a href="https://en.wikipedia.org/wiki/Make_(software)">Make</a> acabei caindo de cabeça automatizando praticamente todos os comandos do <a href="https://docs.aws.amazon.com/cli/latest/reference/lambda/index.html">awscli lambda</a>. Isso no início foi bem legal e importante para entender bem o serviço e os comandos, mas depois de um tempo, com a complexidade de alguns projetos se tornou algo difícil de se manter. Além disso, por mais simples que o Make seja existem pessoas que não gostam de utilizar essa ferramenta por incrível que pareça. Neste caso, construímos uma API para uma empresa toda utilizando lambdas. Este foi o meu primeiro projeto. Meu time definiu a arquitetura, configuração e o processo de deploy.</p>

<h2 id="apex">Apex</h2>

<p>Conheci essa ferramenta através de um amigo após ter criado um “framework em Make” para gerenciar as ações do lambda. Após alguns testes, entendi o potencial do framework e a sua simplicidade para organizar e gerenciar funções no AWS Lambda. Sem sombras de dúvidas entender os comandos facilitaram o entendimento do <a href="http://apex.run/">apex</a>.</p>

<p>O apex propõe uma estrutura de diretórios para se trabalhar com o lambda. Também foi pensada em uma forma de deployar o seu lambda para ambientes diferentes como staging e production por exemplo. Além disso, a ferramenta simplifica a forma de realizar atualizações e deploys no seu lambda criando arquivos de configurações. Com ele fica simples versionar o projeto. Agora vamos ao que interessa vamos conhecer a ferramenta e depois em seguida vou detalhar os principais comandos. Segue abaixo o vídeo de apresentação do apex:</p>

<style>.embed-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; } .embed-container iframe, .embed-container object, .embed-container embed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }</style>
<div class="embed-container">    <iframe title="YouTube video player" width="640" height="390" src="//www.youtube.com/embed/PvvlCvfljz0" frameborder="0" allowfullscreen=""></iframe></div>

<p>Agora que conhecemos o apex, vamos aos principais comandos que executamos no video que são eles:</p>

<ul>
  <li>apex init</li>
  <li>apex deploy</li>
  <li>apex list</li>
</ul>

<h3 id="apex-init">apex init</h3>

<p>Cria a Role na AWS com a configuração mínima de execução do lambda e uma estrutura inicial para se trabalhar com lambdas seguindo este formato:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
├── functions
│ └── hello
│   └── index.js
└── project.json

</code></pre></div></div>

<p>Os comandos deploy e list os nomes são sugestivos e fazem o deploy criando ou atualizando o lambda existente e o outro lista todos os lambdas criados.</p>

<p>Para facilitar o setup de cada linguagem suportada no apex, temos um link na documentação com vários <a href="https://github.com/apex/apex/tree/master/_examples">exemplos de caso de uso que você pode ver clicando neste link.</a></p>

<p>Agora que já temos ideia do que é o apex e como ele funciona, vamos ver como instalar outros pacotes Pythons no nosso lambda.</p>

<h2 id="utilizando-pacotes">Utilizando pacotes</h2>

<p>Sim meus amigos, o lambda suporta instalação de outras bibliotecas em nosso código. Basicamente precisamos instalar as dependências no mesmo diretório onde a nossa função lambda foi criada, zipar todo o conteúdo e subir em seguida para o lambda.</p>

<p>Em outras linguagens como Ruby e JS, as dependências normalmente ficam na raiz do projeto no mesmo nível de diretório onde se encontram os arquivos Gemfile ou Package.json. No Python ao instalar dependências para um projeto precisamos criar uma <a href="https://docs.python.org/3/library/venv.html">virtualenv</a>. E agora como fazer? Então amigos ao invés de rodar o pip instal -r requirements.txt vamos precisar mais um argumento o -t. Esta opção permite a gente passar o caminho onde vão ser criados os arquivos de dependências do nosso projeto. Exemplo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt <span class="nt">-t</span> CAMINHO_PARA_CRIAR_ARQUIVOS_DEPENDENCIAS

</code></pre></div></div>

<p>Logo basta colocar esse caminho para ser o mesmo onde esta no nosso arquivo main.py que é a nossa função lambda e em seguida zipar e subir tudo como fazemos normalmente. Vejamos o seguinte exemplo para utilizar a lib <a href="http://docs.python-requests.org/en/master/">requests</a> do Python.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c">#criando o arquivo main.py</span>
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"
import requests


def handle(event, context):
    r = requests.get('https://api.github.com/events')
    return {
        'texto': r.text,
    }

"</span> <span class="o">&gt;&gt;</span> main.py

<span class="c">#criando o requirements.txt</span>
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"requests"</span> <span class="o">&gt;&gt;</span> requirements.txt

<span class="c">#instalando as dependencias para o lambda</span>
pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt <span class="nt">-t</span> <span class="nb">.</span>

<span class="c"># zipando</span>
zip <span class="nt">-qr</span> hellorequests.zip <span class="nb">.</span>

<span class="c"># criar a nossa função via awscli.</span>
aws lambda create-function <span class="se">\</span>
  <span class="nt">--region</span> us-east-1 <span class="se">\</span>
  <span class="nt">--handler</span> main.handle <span class="se">\</span>
  <span class="nt">--runtime</span> python3.7 <span class="se">\</span>
  <span class="nt">--function-name</span> <span class="s1">'hellorequests'</span> <span class="se">\</span>
  <span class="nt">--zip-file</span> fileb://./hellorequests.zip <span class="se">\</span>
  <span class="nt">--role</span> <span class="s1">'PEGUE_SUA_ARN'</span>

</code></pre></div></div>

<p>Pronto tendo feito isso temos o nosso lambda sendo executado incluindo o requests como dependências. Dessa maneira você pode instalar qualquer biblioteca na sua função lambda. <a href="https://docs.aws.amazon.com/pt_br/lambda/latest/dg/lambda-python-how-to-create-deployment-package.html">Aqui neste link você tem a documentação da AWS explicando em detalhes esse processo.</a></p>

<p>Um grande ponto de atenção ao utilizar dependências com linguagens dinâmicas, é que a algumas bibliotecas feitas em Python fazem <a href="https://en.wikipedia.org/wiki/Wrapper_function">wrapper</a> para funções escritas em C e outras funções do SO. Ou seja, o lambda roda em cima de uma <a href="https://aws.amazon.com/pt/amazon-linux-ami/">Amazon Linux AMI</a> com isso podemos ter problemas de compatibilidades ao instalar bibliotecas. É nessa hora que o <a href="https://www.docker.com/">docker</a> entra para nos ajudar! Ou seja, o ideal para não sofrer com esse tipo de problema e realizar a instalação em um <a href="https://docs.aws.amazon.com/pt_br/AmazonECR/latest/userguide/amazon_linux_container_image.html">container que tenha o Amazon Linux AMI</a>. Acessando o <a href="https://hub.docker.com/">hub docker</a> temos acesso a essa imagem que você pode encontrar também por este link [https://hub.docker.com/<em>/amazonlinux/](https://hub.docker.com/</em>/amazonlinux/).</p>

<p>Agora com esse detalhe em mente vamos realizar a nossa instalação utilizando o docker com a imagem da AWS. Vamos fazer os seguintes passos:</p>

<ol>
  <li>Criar o nosso Dockerfile com as configurações necessários para o Python</li>
  <li>Rodar o container para instalar as dependências</li>
  <li>Subir o nosso lambda</li>
</ol>

<p>Para isso eu criei um gist para mostrar você incluir no seu projeto Python 3.7.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/4ce09756dd3ffe465ca6000f23496af5.js"> </script>

<p>Agora basta criar os arquivos com base no gist e rodar os seguintes comandos:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
make lambda.docker.build lambda.docker.pkgcreate

<span class="c"># zipando</span>

zip <span class="nt">-qr</span> hellorequests.zip <span class="nb">.</span>

<span class="c"># criar a nossa função via awscli.</span>

aws lambda create-function <span class="se">\</span>
  <span class="nt">--region</span> us-east-1 <span class="se">\</span>
  <span class="nt">--handler</span> main.handle <span class="se">\</span>
  <span class="nt">--runtime</span> python3.7 <span class="se">\</span>
  <span class="nt">--function-name</span> <span class="s1">'hellorequests'</span> <span class="se">\</span>
  <span class="nt">--zip-file</span> fileb://./hellorequests.zip <span class="se">\</span>
  <span class="nt">--role</span> <span class="s1">'PEGUE_SUA_ARN'</span>

</code></pre></div></div>

<p>Com isso você tem um ambiente mais “seguro” para instalar as suas dependências. Vale ainda dar uma olhada no projeto <a href="https://github.com/lambci/docker-lambda">lambda-ci</a> que tem uma variedade de imagens prontas para instalar os seus lambdas. Você ainda pode encontrar mais alguns problemas como algumas bibliotecas específicas e caso isso aconteça comente nesse post que eu vou procurar te ajudar ;)</p>

<p>Resumindo mostrei o funcionamento básico do apex, como instalar as dependencias e ficar atento com os possíveis problemas de incompatibilidade de bibliotecas. Nos próximos posts vou mostrar casos reais de utilização do AWS Lambda criando uma api e consumido tarefas em background utilizando SQS e Kinesis.</p>

<p>Comente sobre o que você achou desse post e me conte o você quer saber ou fazer utilizando Python e Lambdas.</p>

<p>Grande abraço!</p>]]></content><author><name>Raffael Tancman</name></author><category term="python" /><category term="aws" /><summary type="html"><![CDATA[Continuando a série de posts relacionados ao AWS Lambda. Caso você tenha lido o primeiro post ou não conheça este serviço da Amazon, recomendo a leitura do artigo AWS Lambda + Python - Como criar o setup de um projeto Python para rodar no AWS Lambda.]]></summary></entry><entry><title type="html">AWS Lambda + Python</title><link href="https://www.rtancman.com.br/python/aws/aws-lambda-e-python.html" rel="alternate" type="text/html" title="AWS Lambda + Python" /><published>2019-01-09T14:10:00+00:00</published><updated>2019-01-09T14:10:00+00:00</updated><id>https://www.rtancman.com.br/python/aws/aws-lambda-e-python</id><content type="html" xml:base="https://www.rtancman.com.br/python/aws/aws-lambda-e-python.html"><![CDATA[<p>Vamos falar de AWS, vamos falar de lambdas e de python! Isso mesmo, nesse artigo vou começar uma série de posts sobre essas tecnologias.</p>

<p>A AWS é uma plataforma de serviços em cloud com as mais variadas funções. Neste artigo vamos abordar o <a href="https://aws.amazon.com/lambda">AWS Lambda</a>. O Lambda é um serviço que permite você rodar códigos sem ter a necessidade de ter uma máquina ligada o tempo todo. O lambda é executado através de gatilhos que são configurados no serviço. Atualmente podemos rodar códigos nas seguintes linguagens:</p>

<ul>
  <li><a href="https://docs.aws.amazon.com/pt_br/lambda/latest/dg/python-programming-model.html">Python</a></li>
  <li><a href="https://docs.aws.amazon.com/pt_br/lambda/latest/dg/java-programming-model.html">Java</a></li>
  <li><a href="https://docs.aws.amazon.com/pt_br/lambda/latest/dg/go-programming-model.html">Go</a></li>
  <li><a href="https://docs.aws.amazon.com/pt_br/lambda/latest/dg/dotnet-programming-model.html">C#</a></li>
  <li><a href="https://docs.aws.amazon.com/pt_br/lambda/latest/dg/lambda-ruby.html">Ruby</a></li>
</ul>

<p>Vamos utilizar o Python para exemplificar como podemos utilizar o lambda. Antes de começar a executar este serviço precisamos entender o contrato que serviço determinou para a sua utilização. Todo código a ser executado precisa estar dentro de uma função de inicialização que recebe 2 argumentos que são o event e o context. A estrutura da função fica nesse formato:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">handler_name</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>  
<span class="p">...</span>  
<span class="k">return</span> <span class="n">some_value</span>

</code></pre></div></div>

<ul>
  <li>
    <p><strong>event:</strong> É o parâmetro principal. Neste argumento recebemos os dados envidados pelos serviços da AWS podendo conter dados de uma mensagem recebida no <a href="https://aws.amazon.com/sqs">SQS</a> e até mesmo dados de um request repassado pelo <a href="https://aws.amazon.com/api-gateway/">API Gateway</a>.</p>
  </li>
  <li>
    <p><strong>context:</strong> Neste recebemos um objeto LambdaContext. Temos neste objeto informações do contexto de invocação deste lambda como a quantidade de memória configurada até o ARN de quem invocou esta função. <a href="https://docs.aws.amazon.com/lambda/latest/dg/python-context-object.html">Aqui temos uma explicação detalhada deste objeto.</a></p>
  </li>
</ul>

<p>Caso você queira saber mais sobre essa estrutura do serviço de uma olhada <a href="https://docs.aws.amazon.com/pt_br/lambda/latest/dg/python-programming-model-handler-types.html">neste item da documentação do lambda.</a></p>

<p>Agora que já conhecemos a estrutura do lambda vamos criar uma função e para isso temos duas opções via console da AWS ou via terminal utilizando o <a href="https://aws.amazon.com/cli/">awscli</a>.</p>

<p>Vamos explorar o console da AWS primeiramente. Acessando o serviço vamos encontra esta tela inicial:</p>

<p><img src="/img/posts/2019/01/awslambda/1-aws-lambda-telainicial.gif" alt="aws lambda tela inicial" /></p>

<p>Atualmente temos na tela de entrada do lambda um sandbox utilizando JS para brincar com o lambda e de fato rodar o seu primeiro “Hello World”. Mas vamos explorar a criação de uma nova função.</p>

<p>Na criação de uma função lambda temos opções para From Scratch, Blueprints e AWS Serveless Aplication Repository.</p>

<ul>
  <li>
    <p><strong>From Scratch:</strong> É para criar funções do zero.</p>
  </li>
  <li>
    <p><strong>Blueprints:</strong> São exemplos de funções para atividades recorrentes na AWS.</p>
  </li>
  <li>
    <p><strong>AWS Serveless Aplication Repository:</strong> São exemplos de aplicações Serverless. Neste temos exemplos de arquiteturas utilizando os serviços da AWS e você consegue facilmente instalar e rodar.</p>
  </li>
</ul>

<p>Nosso foco aqui é mostrar a utilização do lambda From Scratch. Vamos criar uma função lambda com suporte a linguagem python na versão 3.7. O lambda precisa de uma role para execução e você pode criar <a href="https://docs.aws.amazon.com/pt_br/lambda/latest/dg/intro-permission-model.html">seguindo essa documentação</a>. Para o nosso exemplo vamos criar uma AWSLambdaBasicExecutionRole.
<img src="/img/posts/2019/01/awslambda/2-aws-lambda-criando-role.gif" alt="aws lambda criando role" /></p>

<p>Lembrando que você também pode utilizar as templates disponíveis para o serviço que você vai ligar a sua função lambda.
<img src="/img/posts/2019/01/awslambda/3-aws-lambda-criando-role-seguindo-templates.gif" alt="aws lambda criando role seguindo templates" /></p>

<p>Com a nossa role criada vamos ao que interessa e criar a nossa função lambda!
<img src="/img/posts/2019/01/awslambda/4-aws-lambda-criando.gif" alt="aws lambda criando" /></p>

<p>Após a criação da função vamos cair na tela configuração da função. Aqui podemos escolher os serviços que vão ser os gatilhos para rodar o nosso lambda, podemos trocar o runtime para outras linguagens, setar variáveis de ambientes, quantidade de memória, tempo máximo de execução, escrever o nosso código em um editor web e colocar a nossa função para executar rodando testes. Fiz um video curto explicando esse console do lambda. Veja abaixo:</p>

<style>.embed-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; } .embed-container iframe, .embed-container object, .embed-container embed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }</style>
<div class="embed-container">    <iframe title="YouTube video player" width="640" height="390" src="//www.youtube.com/embed/Mr2XT_6HPSo" frameborder="0" allowfullscreen=""></iframe></div>

<p>Vamos de <a href="https://aws.amazon.com/pt/cli/?nc1=h_ls">awscli</a>, terminal!!! Como a maioria dos serviços da AWS temos uma interface de linha de comando. Para isso você vai precisar instalar essa ferramenta em sua máquina. O awscli é feito em Python &lt;3 e por esse motivo vou utilizar o pip para a sua instalação. <a href="https://docs.aws.amazon.com/pt_br/cli/latest/userguide/cli-chap-install.html">Neste link você tem acesso a documentação da AWS explicando como instalar.</a> Segue o comando para instalar usando o pip:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
pip <span class="nb">install </span>awscli

<span class="c">#validando se o awscli foi instalado corretamente</span>

aws <span class="nt">--version</span>

</code></pre></div></div>

<p>Com tudo instalado agora vamos precisar configurar a sua conta e para isso vamos rodar o seguinte comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
aws configure

</code></pre></div></div>

<p>Após rodar esse comando vamos precisar colocar o seu AWS Access Key ID, AWS Secret Access Key, uma região default e o formato de output.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
AWS Access Key ID <span class="o">[</span>None]: AKIAIOSFODNN7EXAMPLE
AWS Secret Access Key <span class="o">[</span>None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
Default region name <span class="o">[</span>None]: us-west-2
Default output format <span class="o">[</span>None]: json

</code></pre></div></div>

<p><a href="https://docs.aws.amazon.com/pt_br/cli/latest/userguide/cli-chap-configure.html">Nesse link você encontra a documentação completa e mais detalhes para realizar essa configuração.</a></p>

<p>Com tudo configurado vamos dar uma olhada nos comandos do lambda rodando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
aws lambda <span class="nb">help</span>

</code></pre></div></div>

<p><img src="/img/posts/2019/01/awslambda/5-aws-lambda-cli-help.gif" alt="aws lambda cli help" /></p>

<p>No help temos todos os comandos disponíveis para configurar o serviço pelo terminal. Vamos focar nesse artigo nos seguintes comandos:</p>

<ul>
  <li>aws lambda create-function</li>
  <li>aws lambda list-functions</li>
  <li>aws lambda update-function-code</li>
  <li>aws lambda invoke</li>
  <li>aws lambda delete-function</li>
</ul>

<p>aws lambda create-function
Como o nome já diz é função utilizada para criar uma função lambda. Vamos ao comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
aws lambda create-function <span class="se">\</span>
<span class="nt">--region</span> us-east-1 <span class="se">\</span>
<span class="nt">--handler</span> main.handler <span class="se">\</span>
<span class="nt">--runtime</span> python3.7 <span class="se">\</span>
<span class="nt">--function-name</span> <span class="s1">'awscli-create-lambda'</span> <span class="se">\</span>
<span class="nt">--zip-file</span> fileb://./awsclicreatelambda.zip <span class="se">\</span>
<span class="nt">--role</span> <span class="s1">'arn:aws:iam::032292203206:role/AWSLambdaBasicExecutionRole'</span>

</code></pre></div></div>

<ul>
  <li>
    <p><strong>–zip-file:</strong> No caso de subir um zip com menos de 10mb você deve usar o parametro –zip-file fileb://PATH_PARA_O_ZIP</p>
  </li>
  <li>
    <p><strong>–role:</strong> Aqui precisamos pegar a <a href="https://docs.aws.amazon.com/pt_br/general/latest/gr/aws-arns-and-namespaces.html">ARN</a> da role. Neste caso você consegue essa informação acessando a sessão de IAM e navegando até a role e clicando para ver os detalhes dela.</p>
  </li>
</ul>

<p>Este é o mínimo de argumentos que você precisa passar no modo cli para criar um lambda. Como pode perceber temos um arquivo .zip que neste exemplo tem o nome de awsclicreatelambda.zip . Exatamente precisamos zipar o nosso arquivo antes de subir nossa função para o lambda. Para zipar precisamos do arquivo que vai conter a nossa função python. Abaixo segue os dados que vamos usar neste exemplo.</p>

<p>Criando o arquivo main.py</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"

def handler(event, context):
    return {
        'texto': 'hello world lambda usando awscli',
    }

"</span> <span class="o">&gt;&gt;</span> main.py

</code></pre></div></div>

<p>Zipando o arquivo main.py</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
zip <span class="nt">-qr</span> awsclicreatelambda.zip main.py

</code></pre></div></div>

<p>Agora que já temos o nosso zip vamos criar a nossa função via awscli.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
aws lambda create-function <span class="se">\</span>
<span class="nt">--region</span> us-east-1 <span class="se">\</span>
<span class="nt">--handler</span> main.handler <span class="se">\</span>
<span class="nt">--runtime</span> python3.7 <span class="se">\</span>
<span class="nt">--function-name</span> <span class="s1">'awscli-create-lambda'</span> <span class="se">\</span>
<span class="nt">--zip-file</span> fileb://./awsclicreatelambda.zip <span class="se">\</span>
<span class="nt">--role</span> <span class="s1">'PEGUE_SUA_ARN'</span>

</code></pre></div></div>

<p>Se tudo ocorreu com sucesso você deve ter recebido uma resposta como essa e agora conseguimos visualizar o nosso lambda no console da aws.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">{</span>
  <span class="s2">"FunctionName"</span>: <span class="s2">"awscli-create-lambda"</span>,
  <span class="s2">"FunctionArn"</span>: <span class="s2">"arn:aws:lambda:us-east-1:XXXXXXXXX:function:awscli-create-lambda"</span>,
  <span class="s2">"Runtime"</span>: <span class="s2">"python3.7"</span>,
  <span class="s2">"Role"</span>: <span class="s2">"arn:aws:iam::XXXXXXXXXXX:role/AWSLambdaBasicExecutionRole"</span>,
  <span class="s2">"Handler"</span>: <span class="s2">"main.handler"</span>,
  <span class="s2">"CodeSize"</span>: 254,
  <span class="s2">"Description"</span>: <span class="s2">""</span>,
  <span class="s2">"Timeout"</span>: 3,
  <span class="s2">"MemorySize"</span>: 128,
  <span class="s2">"LastModified"</span>: <span class="s2">"2019-01-09T20:21:51.059+0000"</span>,
  <span class="s2">"CodeSha256"</span>: <span class="s2">"tpv2milsG+tB6qZWt4CPbtU4JxUXSxwK0aWsl0lbX6g="</span>,
  <span class="s2">"Version"</span>: <span class="s2">"</span><span class="nv">$LATEST</span><span class="s2">"</span>,
  <span class="s2">"TracingConfig"</span>: <span class="o">{</span>
    <span class="s2">"Mode"</span>: <span class="s2">"PassThrough"</span>
  <span class="o">}</span>,
  <span class="s2">"RevisionId"</span>: <span class="s2">"e2d3b109-1312-4eb9-80da-f8c710176541"</span>
<span class="o">}</span>

</code></pre></div></div>

<p>aws lambda list-functions
Vamos fazer um double check e listar as funções existentes na AWS.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
aws lambda list-functions

</code></pre></div></div>

<p>Você deve receber uma lista com as configurações de cada lambda como essa aqui abaixo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">{</span>
  <span class="s2">"Functions"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"FunctionName"</span>: <span class="s2">"helloworld"</span>,
      <span class="s2">"FunctionArn"</span>: <span class="s2">"arn:aws:lambda:us-east-1:XXX:function:helloworld"</span>,
      <span class="s2">"Runtime"</span>: <span class="s2">"python3.7"</span>,
      <span class="s2">"Role"</span>: <span class="s2">"arn:aws:iam::XXXX:role/AWSLambdaBasicExecutionRole"</span>,
      <span class="s2">"Handler"</span>: <span class="s2">"lambda_function.lambda_handler"</span>,
      <span class="s2">"CodeSize"</span>: 272,
      <span class="s2">"Description"</span>: <span class="s2">""</span>,
      <span class="s2">"Timeout"</span>: 3,
      <span class="s2">"MemorySize"</span>: 128,
      <span class="s2">"LastModified"</span>: <span class="s2">"2019-01-08T23:32:13.046+0000"</span>,
      <span class="s2">"CodeSha256"</span>: <span class="s2">"Amrs9cH7J7bkB5kMuvxiVzodlZCSee1bcSZFN4KjNLs="</span>,
      <span class="s2">"Version"</span>: <span class="s2">"</span><span class="nv">$LATEST</span><span class="s2">"</span>,
      <span class="s2">"VpcConfig"</span>: <span class="o">{</span>
        <span class="s2">"SubnetIds"</span>: <span class="o">[]</span>,
        <span class="s2">"SecurityGroupIds"</span>: <span class="o">[]</span>,
        <span class="s2">"VpcId"</span>: <span class="s2">""</span>
      <span class="o">}</span>,
      <span class="s2">"Environment"</span>: <span class="o">{</span>
        <span class="s2">"Variables"</span>: <span class="o">{</span>
          <span class="s2">"TESTE"</span>: <span class="s2">"LALA"</span>
        <span class="o">}</span>
      <span class="o">}</span>,
      <span class="s2">"TracingConfig"</span>: <span class="o">{</span>
        <span class="s2">"Mode"</span>: <span class="s2">"PassThrough"</span>
      <span class="o">}</span>,
      <span class="s2">"RevisionId"</span>: <span class="s2">"863e4b1e-99cd-4cfc-8f8c-0644af4d5b38"</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"FunctionName"</span>: <span class="s2">"awscli-create-lambda"</span>,
      <span class="s2">"FunctionArn"</span>: <span class="s2">"arn:aws:lambda:us-east-1:XXXXX:function:awscli-create-lambda"</span>,
      <span class="s2">"Runtime"</span>: <span class="s2">"python3.7"</span>,
      <span class="s2">"Role"</span>: <span class="s2">"arn:aws:iam::XXXXXXXX:role/AWSLambdaBasicExecutionRole"</span>,
      <span class="s2">"Handler"</span>: <span class="s2">"main.handler"</span>,
      <span class="s2">"CodeSize"</span>: 254,
      <span class="s2">"Description"</span>: <span class="s2">""</span>,
      <span class="s2">"Timeout"</span>: 3,
      <span class="s2">"MemorySize"</span>: 128,
      <span class="s2">"LastModified"</span>: <span class="s2">"2019-01-09T20:21:51.059+0000"</span>,
      <span class="s2">"CodeSha256"</span>: <span class="s2">"tpv2milsG+tB6qZWt4CPbtU4JxUXSxwK0aWsl0lbX6g="</span>,
      <span class="s2">"Version"</span>: <span class="s2">"</span><span class="nv">$LATEST</span><span class="s2">"</span>,
      <span class="s2">"TracingConfig"</span>: <span class="o">{</span>
        <span class="s2">"Mode"</span>: <span class="s2">"PassThrough"</span>
      <span class="o">}</span>,
      <span class="s2">"RevisionId"</span>: <span class="s2">"e2d3b109-1312-4eb9-80da-f8c710176541"</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>

</code></pre></div></div>

<p>aws lambda update-function-code
Para atualizar o codigo lambda basta rodar o seguinte comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
aws lambda update-function-code <span class="se">\</span>
<span class="nt">--region</span> us-east-1 <span class="se">\</span>
<span class="nt">--function-name</span> <span class="s1">'awscli-create-lambda'</span> <span class="se">\</span>
<span class="nt">--zip-file</span> fileb://./awsclicreatelambda.zip

</code></pre></div></div>

<p>Este é o output esperado:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">{</span>
  <span class="s2">"FunctionName"</span>: <span class="s2">"awscli-create-lambda"</span>,
  <span class="s2">"FunctionArn"</span>: <span class="s2">"arn:aws:lambda:us-east-1:XXXX:function:awscli-create-lambda"</span>,
  <span class="s2">"Runtime"</span>: <span class="s2">"python3.7"</span>,
  <span class="s2">"Role"</span>: <span class="s2">"arn:aws:iam::XXXX:role/AWSLambdaBasicExecutionRole"</span>,
  <span class="s2">"Handler"</span>: <span class="s2">"main.handler"</span>,
  <span class="s2">"CodeSize"</span>: 254,
  <span class="s2">"Description"</span>: <span class="s2">""</span>,
  <span class="s2">"Timeout"</span>: 3,
  <span class="s2">"MemorySize"</span>: 128,
  <span class="s2">"LastModified"</span>: <span class="s2">"2019-01-09T20:41:49.473+0000"</span>,
  <span class="s2">"CodeSha256"</span>: <span class="s2">"tpv2milsG+tB6qZWt4CPbtU4JxUXSxwK0aWsl0lbX6g="</span>,
  <span class="s2">"Version"</span>: <span class="s2">"</span><span class="nv">$LATEST</span><span class="s2">"</span>,
  <span class="s2">"TracingConfig"</span>: <span class="o">{</span>
    <span class="s2">"Mode"</span>: <span class="s2">"PassThrough"</span>
  <span class="o">}</span>,
  <span class="s2">"RevisionId"</span>: <span class="s2">"2ae6d782-dde0-41d1-8227-db3bfa23d30f"</span>
<span class="o">}</span>

</code></pre></div></div>

<p>aws lambda invoke
Executando um lambda precisamos passar o nome da função, o paylod que neste caso tem que ser um json e passar um arquivo onde vai ser escrito a resposta dessa invocação.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
aws lambda invoke <span class="se">\</span>
<span class="nt">--function-name</span> <span class="s1">'awscli-create-lambda'</span> <span class="se">\</span>
<span class="nt">--payload</span> <span class="s1">'{}'</span> <span class="se">\</span>
awsclicreatelambda.output

<span class="c"># para ver o resultado basta agora dar um cat no arquivo</span>

<span class="nb">cat </span>awsclicreatelambda.output

</code></pre></div></div>

<p>aws lambda delete-function</p>

<p>Vamos remover este lambda recem criado rodando o comando delete-function. Este comando não tem output.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
aws lambda delete-function <span class="se">\</span>
<span class="nt">--region</span> us-east-1 <span class="se">\</span>
<span class="nt">--function-name</span> <span class="s1">'awscli-create-lambda'</span>

</code></pre></div></div>

<p>Para facilitar também criei este <a href="https://gist.github.com/rtancman/240e67545a4dbde5107cd1dd09df014b">gist no github</a> com todos os comandos que executamos em sequência.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/240e67545a4dbde5107cd1dd09df014b.js"> </script>

<p>Neste post procurei mostrar o funcionamento básico do lambda e as diversas formas que podemos manipular as nossas funções que podem ser feitas via console da AWS ou utilizando o utilitário awscli. Fique ligado que nos próximos posts vou mostrar como podemos otimizar toda essa configuração utilizando o framework <a href="http://apex.run/">apex</a>.</p>

<p>Veja como <a href="/python/aws/organizando-aws-lambda-escrito-python.html">organizar o ambiente de trabalho com apex.run e entenda as pegadinhas em utilizar Python no AWS Lambda.</a></p>

<p>Comente sobre o que você achou desse post e me conte o você quer saber ou fazer utilizando Python e Lambdas.</p>

<p>Grande abraço!</p>]]></content><author><name>Raffael Tancman</name></author><category term="python" /><category term="aws" /><summary type="html"><![CDATA[Vamos falar de AWS, vamos falar de lambdas e de python! Isso mesmo, nesse artigo vou começar uma série de posts sobre essas tecnologias.]]></summary></entry></feed>